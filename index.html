<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Masters Pro - Bot & Friends</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #18191a; color: #e4e6eb; font-family: 'Roboto', sans-serif; }
        .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .card-dark { background-color: #242526; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid #333; }
        .btn-primary-custom { background-color: #2D88FF; color: white; font-weight: bold; border: none; }
        .btn-primary-custom:hover { background-color: #1A73E8; color: white; }
        .btn-bot { background-color: #e67e22; color: white; font-weight: bold; border: none; }
        .btn-bot:hover { background-color: #d35400; color: white; }
        .btn-private { background-color: #9b59b6; color: white; font-weight: bold; border: none; }
        .btn-private:hover { background-color: #8e44ad; color: white; }
        
        .hidden { display: none !important; }
        .id-badge { background: #3a3b3c; color: #b0b3b8; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }

        #board { width: 100%; border: 4px solid #3a3b3c; border-radius: 4px; user-select: none; }
        .board-wrapper { position: relative; max-width: 550px; margin: 0 auto; }
        
        /* Queue Overlay */
        #queue-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(36, 37, 38, 0.95); z-index: 500;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            border-radius: 10px;
        }
        .pulse-ring {
            border: 4px solid #2D88FF; border-radius: 50%; height: 60px; width: 60px;
            animation: pulsate 2s infinite; margin-bottom: 20px;
        }
        @keyframes pulsate { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

        /* End Screen Overlay */
        #end-screen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .end-card { background: #242526; padding: 40px; border-radius: 20px; text-align: center; border: 2px solid #444; min-width: 300px; }
        .win-title { font-size: 3rem; font-weight: 900; color: #2ecc71; text-shadow: 0 0 20px rgba(46, 204, 113, 0.5); }
        .lose-title { font-size: 3rem; font-weight: 900; color: #e74c3c; text-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .modal-content-custom { background: #242526; width: 400px; padding: 20px; border-radius: 10px; border: 1px solid #3a3b3c; }

        .move-log { height: 250px; overflow-y: auto; background: #18191a; padding: 10px; border-radius: 6px; }

        /* --- Click System Styles --- */
        .highlight-dot {
            background-color: rgba(45, 136, 255, 0.8);
            width: 25%; height: 25%; border-radius: 50%;
            position: absolute; top: 37.5%; left: 37.5%; pointer-events: none;
        }
        .highlight-square { box-shadow: inset 0 0 3px 3px rgba(255, 255, 0, 0.5); }
        .square-55d63 { cursor: pointer; }
    </style>
</head>
<body>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content-custom">
            <h4>Einstellungen</h4>
            <input type="text" id="settings-username" class="form-control mb-3" placeholder="Neuer Name">
            <input type="password" id="settings-password" class="form-control mb-3" placeholder="Neues Passwort">
            <div class="d-flex justify-content-end gap-2">
                <button onclick="closeSettings()" class="btn btn-secondary">Abbrechen</button>
                <button onclick="saveSettings()" class="btn btn-success">Speichern</button>
            </div>
            <div id="settings-msg" class="mt-2 small"></div>
        </div>
    </div>

    <div id="end-screen-overlay" class="hidden">
        <div class="end-card">
            <div id="end-title" class="win-title">SIEG!</div>
            <p id="end-reason" class="text-muted my-3">...</p>
            <button onclick="backToLobby()" class="btn btn-light btn-lg w-100 fw-bold">Zurück zur Lobby</button>
        </div>
    </div>

    <div class="app-container">
        
        <div class="d-flex justify-content-between align-items-center mb-4 p-3 card-dark">
            <h3 class="m-0 fw-bold"><i class="fas fa-chess"></i> CHESS PRO</h3>
            <div id="nav-user-area" class="hidden d-flex align-items-center gap-3">
                <div>
                    <span id="nav-username" class="fw-bold text-white">Gast</span>
                    <span id="nav-userid" class="id-badge">#?</span>
                </div>
                <button onclick="openSettings()" class="btn btn-sm btn-outline-light"><i class="fas fa-cog"></i></button>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
            </div>
        </div>

        <div id="auth-screen">
            <div class="card-dark text-center" style="max-width: 400px; margin: 50px auto;">
                <h3>Login</h3>
                <input type="email" id="email-input" class="form-control mb-2" placeholder="E-Mail">
                <input type="password" id="password-input" class="form-control mb-3" placeholder="Passwort">
                <input type="text" id="username-input" class="form-control mb-3" placeholder="Username (nur Registrierung)">
                <button onclick="loginUser()" class="btn btn-primary-custom w-100 mb-2">Login</button>
                <button onclick="registerUserWithId()" class="btn btn-outline-light w-100">Konto erstellen</button>
                <div id="auth-error" class="text-danger mt-2 small"></div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden">
            <div class="row">
                <div class="col-md-7">
                    <div class="card-dark text-center" style="padding: 30px 20px; position: relative; min-height: 400px;">
                        
                        <div id="queue-overlay" class="hidden">
                            <div class="pulse-ring"></div>
                            <h3>Suche Gegner...</h3>
                            <p class="text-muted">Ranked Matchmaking</p>
                            <p class="small text-muted" id="queue-time">0s</p>
                            <button onclick="leaveQueue()" class="btn btn-outline-danger mt-3">Abbrechen</button>
                        </div>

                        <h2 class="fw-bold mb-4">Modus wählen</h2>
                        
                        <div class="d-grid gap-3">
                            <button onclick="joinQueue()" class="btn btn-primary-custom btn-lg p-3">
                                <i class="fas fa-trophy"></i> RANKED SPIELEN (Warteschlange)
                            </button>
                            
                            <div class="row g-2">
                                <div class="col-6">
                                    <button onclick="startBotGame()" class="btn btn-bot w-100 p-3">
                                        <i class="fas fa-robot"></i> GEGEN BOT
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button onclick="createPrivateGame()" class="btn btn-private w-100 p-3">
                                        <i class="fas fa-user-secret"></i> PRIVATER RAUM
                                    </button>
                                </div>
                            </div>
                        </div>

                        <hr>
                        <p class="small text-muted mb-1">Privatem Spiel beitreten:</p>
                        <div class="d-flex justify-content-center gap-2">
                            <input type="text" id="join-id-input" class="form-control" style="max-width: 150px;" placeholder="Code eingeben...">
                            <button onclick="joinGameByCode()" class="btn btn-secondary">Beitreten</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-5">
                    <div class="card-dark">
                        <h5 class="text-info"><i class="fas fa-user-friends"></i> Freunde</h5>
                        <div class="input-group mb-2">
                            <input type="number" id="friend-id-input" class="form-control" placeholder="User ID (z.B. 42)">
                            <button onclick="addFriendById()" class="btn btn-outline-info">Add</button>
                        </div>
                        <div id="friends-list" style="max-height: 150px; overflow-y: auto;" class="small">
                            <span class="text-muted">Lade Freunde...</span>
                        </div>
                    </div>

                    <div class="card-dark">
                        <h5 class="text-warning"><i class="fas fa-trophy"></i> Top Wins</h5>
                        <div id="leaderboard-list" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="row">
                <div class="col-lg-7">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="player-top"><i class="fas fa-user"></i> Gegner</span>
                        <span id="game-status-text" class="badge bg-success">Spiel läuft</span>
                    </div>
                    
                    <div class="board-wrapper">
                        <div id="board"></div>
                        <div id="wait-overlay" class="hidden board-overlay">
                            <h4 class="text-white">Warte auf Gegner...</h4>
                            <p class="text-muted">Teile diesen Code:</p>
                            <h2 class="text-warning user-select-all" id="private-code-display">...</h2>
                            <button onclick="leaveGame()" class="btn btn-outline-danger btn-sm mt-3">Abbrechen</button>
                        </div>
                    </div>

                    <div class="mt-2">
                        <span id="player-bottom"><i class="fas fa-user"></i> Du</span>
                    </div>
                </div>

                <div class="col-lg-5 mt-3 mt-lg-0">
                    <div class="card-dark h-100 d-flex flex-column">
                        <h5>Verlauf</h5>
                        <div id="move-history" class="move-log flex-grow-1 mb-3"></div>
                        <button onclick="leaveGame()" class="btn btn-danger w-100">Aufgeben / Verlassen</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqCKRhB87r_r-IgbOd9ESm9MQLKTGwSU0",
            authDomain: "chess-dff93.firebaseapp.com",
            projectId: "chess-dff93",
            storageBucket: "chess-dff93.firebasestorage.app",
            messagingSenderId: "1013706120323",
            appId: "1:1013706120323:web:768c8e77c5f49479150fb6",
            measurementId: "G-SK8BMR8YKF"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let userData = null;
        let game = new Chess();
        let board = null;
        let currentGameId = null;
        let myColor = 'w';
        let gameMode = 'online'; // 'online' oder 'bot'
        
        let gameListener = null;
        let queueListener = null;
        let queueTimerInterval = null;
        let selectedSquare = null;

        // --- 2. AUTH & INIT ---
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        userData = doc.data();
                        updateNavUI();
                        showScreen('lobby-screen');
                        updateLeaderboard();
                        loadFriends();
                        checkQueueStatus();
                    }
                });
            } else {
                showScreen('auth-screen');
            }
        });

        // --- 3. NEUE FEATURES ---

        // A. BOT MODUS
        function startBotGame() {
            gameMode = 'bot';
            myColor = 'w';
            currentGameId = 'bot-game';
            
            showScreen('game-screen');
            $('#end-screen-overlay').addClass('hidden');
            $('#wait-overlay').addClass('hidden');
            
            initBoardConfig();
            $('#player-top').text("Computer (Level 1)");
            $('#player-bottom').text("Du (Weiß)");
            $('#game-status-text').text("Lokal vs Bot");
            
            game = new Chess();
            board.position('start');
        }

        function makeBotMove() {
            if(game.game_over()) return;
            
            // Einfache KI: Schlage Figur, wenn möglich. Sonst Random.
            const moves = game.moves({ verbose: true });
            if(moves.length === 0) return;

            // Suche nach Captures
            let bestMove = moves.find(m => m.flags.includes('c') || m.flags.includes('e')); // Capture or En Passant
            
            // Wenn kein Capture, nimm zufälligen Zug
            if(!bestMove) {
                bestMove = moves[Math.floor(Math.random() * moves.length)];
            }
            
            game.move(bestMove.san);
            board.position(game.fen());
            addLog("Bot: " + bestMove.san);
            checkGameOverLocally();
        }

        // B. PRIVATE GAME
        function createPrivateGame() {
            gameMode = 'online';
            const gameRef = db.collection('games').doc();
            const code = Math.random().toString(36).substring(2, 7).toUpperCase(); // Kurzer Code

            // Wir nutzen die ID als Code, aber erstellen ein Feld 'code' für schönere Optik
            // Einfachheitshalber: ID ist der Code
            db.collection('games').doc(code).set({
                white: currentUser.uid, whiteName: userData.username, whiteId: userData.displayId,
                black: null, fen: 'start', turn: 'w', status: 'waiting_private',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                loadOnlineGame(code);
                $('#wait-overlay').removeClass('hidden'); // Zeige Warte-Screen
                $('#private-code-display').text(code);
            });
        }

        // C. FREUNDE PER ID
        function addFriendById() {
            const idInput = $('#friend-id-input').val();
            if(!idInput) return;
            const targetId = parseInt(idInput); // String zu Zahl machen

            db.collection('users').where('displayId', '==', targetId).get().then(snap => {
                if(snap.empty) {
                    alert("Nutzer mit ID #" + targetId + " nicht gefunden.");
                } else {
                    const friendDoc = snap.docs[0];
                    const friendData = friendDoc.data();
                    
                    if(friendData.uid === currentUser.uid) return alert("Das bist du selbst.");

                    // In Array speichern
                    db.collection('users').doc(currentUser.uid).update({
                        friends: firebase.firestore.FieldValue.arrayUnion(friendData.uid)
                    }).then(() => {
                        alert("Freund hinzugefügt!");
                        $('#friend-id-input').val('');
                    });
                }
            });
        }

        function loadFriends() {
            if(!userData.friends || userData.friends.length === 0) {
                $('#friends-list').html('<span class="text-muted">Keine Freunde.</span>');
                return;
            }

            // Wir laden die Freundesdaten. Achtung: Bei vielen Freunden ist das ineffizient, 
            // aber für dieses Projekt okay.
            $('#friends-list').html('');
            userData.friends.forEach(uid => {
                db.collection('users').doc(uid).get().then(doc => {
                    if(doc.exists) {
                        const f = doc.data();
                        const isOnline = f.status === 'online' ? '<span class="text-success">●</span>' : '<span class="text-muted">○</span>';
                        $('#friends-list').append(`
                            <div class="d-flex justify-content-between p-1 border-bottom border-dark">
                                <span>${isOnline} ${f.username} <span class="text-muted">#${f.displayId}</span></span>
                            </div>
                        `);
                    }
                });
            });
        }

        // --- 4. QUEUE & MATCHMAKING ---
        function joinQueue() {
            gameMode = 'online';
            if(!userData) return;
            showQueueUI();
            db.collection('queue').doc(currentUser.uid).set({
                uid: currentUser.uid, username: userData.username, displayId: userData.displayId,
                joinedAt: firebase.firestore.FieldValue.serverTimestamp(), gameId: null
            }).then(() => {
                attemptMatchmaking();
                listenToMyQueueEntry();
            });
        }

        async function attemptMatchmaking() {
            try {
                const snapshot = await db.collection('queue').orderBy('joinedAt', 'asc').limit(2).get();
                if (snapshot.size >= 2) {
                    const p1 = snapshot.docs[0].data();
                    const p2 = snapshot.docs[1].data();
                    await db.runTransaction(async (t) => {
                        const newGameRef = db.collection('games').doc();
                        t.update(db.collection('queue').doc(p1.uid), { gameId: newGameRef.id });
                        t.update(db.collection('queue').doc(p2.uid), { gameId: newGameRef.id });
                        t.set(newGameRef, {
                            white: p1.uid, whiteName: p1.username, whiteId: p1.displayId,
                            black: p2.uid, blackName: p2.username, blackId: p2.displayId,
                            fen: 'start', turn: 'w', status: 'active', result: null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                }
            } catch (e) { console.log(e); }
        }

        function listenToMyQueueEntry() {
            if(queueListener) queueListener();
            queueListener = db.collection('queue').doc(currentUser.uid).onSnapshot(doc => {
                if(doc.exists && doc.data().gameId) {
                    loadOnlineGame(doc.data().gameId);
                    db.collection('queue').doc(currentUser.uid).delete();
                } else if(!doc.exists) hideQueueUI();
            });
        }

        function leaveQueue() { db.collection('queue').doc(currentUser.uid).delete(); hideQueueUI(); }
        function checkQueueStatus() {
            db.collection('queue').doc(currentUser.uid).get().then(doc => {
                if(doc.exists) {
                    if(doc.data().gameId) {
                        loadOnlineGame(doc.data().gameId);
                        db.collection('queue').doc(currentUser.uid).delete();
                    } else { showQueueUI(); listenToMyQueueEntry(); attemptMatchmaking(); }
                }
            });
        }
        function showQueueUI() { $('#queue-overlay').removeClass('hidden'); let s = 0; if(queueTimerInterval) clearInterval(queueTimerInterval); queueTimerInterval = setInterval(() => { s++; $('#queue-time').text(`${s}s`); }, 1000); }
        function hideQueueUI() { $('#queue-overlay').addClass('hidden'); if(queueTimerInterval) clearInterval(queueTimerInterval); if(queueListener) queueListener(); }

        // --- 5. GAME ENGINE (CLICK) ---
        function initBoardConfig() {
            game = new Chess();
            $('#move-history').empty();
            selectedSquare = null;
            board = Chessboard('board', {
                position: 'start', draggable: false,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
            $('#board').off('click').on('click', '.square-55d63', handleSquareClick);
        }

        function loadOnlineGame(id) {
            gameMode = 'online';
            currentGameId = id;
            hideQueueUI();
            showScreen('game-screen');
            $('#end-screen-overlay').addClass('hidden');
            $('#wait-overlay').addClass('hidden');

            initBoardConfig();

            if(gameListener) gameListener();
            
            gameListener = db.collection('games').doc(id).onSnapshot(doc => {
                const data = doc.data();
                if(!data) return; 

                if (data.white === currentUser.uid) myColor = 'w';
                else if (data.black === currentUser.uid) myColor = 'b';
                
                // UI & Status
                if(data.status === 'active') {
                    $('#wait-overlay').addClass('hidden');
                    const enemyName = (myColor === 'w') ? data.blackName : data.whiteName;
                    $('#player-top').text(enemyName);
                    $('#player-bottom').text("Du (" + (myColor==='w'?'Weiß':'Schwarz') + ")");
                }

                // Board drehen
                board.orientation(myColor === 'w' ? 'white' : 'black');

                // Aborted?
                if(data.status === 'aborted') { showEndScreen('GEWONNEN!', 'Gegner ist weg.', 'win'); return; }

                // Move Update
                if(data.fen && data.fen !== game.fen()) {
                    game.load(data.fen);
                    board.position(data.fen);
                    removeHighlights();
                    if(data.lastMoveSan) addLog(data.lastMoveSan);
                }

                if (data.result) handleGameEnd(data.result);
            });
        }

        // CLICK HANDLING
        function handleSquareClick(e) {
            // Egal ob Bot oder Online, Prüfung ist gleich
            if(game.game_over()) return;
            if(gameMode === 'online' && game.turn() !== myColor) return;
            if(gameMode === 'bot' && game.turn() !== 'w') return; // Im Bot Modus ist man immer Weiß

            const square = $(this).attr('data-square');

            if (selectedSquare) {
                const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
                if (move) {
                    // ZUG GEMACHT
                    selectedSquare = null;
                    removeHighlights();
                    
                    if(gameMode === 'online') {
                        sendMoveOnline(move);
                    } else {
                        // Bot Mode Local Updates
                        board.position(game.fen());
                        addLog(move.san);
                        checkGameOverLocally();
                        // Bot Antwort verzögert
                        setTimeout(makeBotMove, 500);
                    }
                } else {
                    const piece = game.get(square);
                    if (piece && piece.color === (gameMode==='online'?myColor:'w')) {
                        selectedSquare = square; highlightPossibleMoves(square);
                    } else { selectedSquare = null; removeHighlights(); }
                }
            } else {
                const piece = game.get(square);
                if (piece && piece.color === (gameMode==='online'?myColor:'w')) {
                    selectedSquare = square; highlightPossibleMoves(square);
                }
            }
        }

        function sendMoveOnline(move) {
            let result = null; let status = 'active';
            if (game.game_over()) {
                if (game.in_checkmate()) { result = game.turn() === 'w' ? 'b' : 'w'; incrementWins(); }
                else if (game.in_draw()) { result = 'draw'; }
                status = 'finished';
            }
            db.collection('games').doc(currentGameId).update({
                fen: game.fen(), turn: game.turn(), lastMoveSan: move.san, result: result, status: status
            });
            board.position(game.fen());
            addLog(move.san);
        }

        function checkGameOverLocally() {
             if (game.game_over()) {
                if(game.in_checkmate()) {
                    // Wer hat gewonnen?
                    if(game.turn() === 'b') showEndScreen('SIEG!', 'Bot Matt gesetzt.', 'win');
                    else showEndScreen('VERLOREN!', 'Bot hat dich zerlegt.', 'lose');
                } else {
                    showEndScreen('REMIS', 'Unentschieden.', 'draw');
                }
             }
        }

        function highlightPossibleMoves(square) {
            removeHighlights();
            $(`.square-${square}`).addClass('highlight-square');
            game.moves({ square: square, verbose: true }).forEach(move => {
                $(`.square-${move.to}`).append('<div class="highlight-dot"></div>');
            });
        }
        function removeHighlights() { $('.square-55d63').removeClass('highlight-square'); $('.highlight-dot').remove(); }

        // --- COMMON ---
        function handleGameEnd(result) {
            if (result === 'draw') showEndScreen('REMIS', 'Unentschieden.', 'draw');
            else if (result === myColor) showEndScreen('GEWONNEN!', 'Du hast gewonnen.', 'win');
            else showEndScreen('VERLOREN', 'Schachmatt.', 'lose');
        }
        function showEndScreen(title, reason, type) {
            $('#end-screen-overlay').removeClass('hidden');
            $('#end-title').text(title).removeClass().addClass(type==='win'?'win-title':(type==='lose'?'lose-title':'draw-title'));
            $('#end-reason').text(reason);
        }
        function backToLobby() { if(gameListener) gameListener(); $('#end-screen-overlay').addClass('hidden'); showScreen('lobby-screen'); }
        function incrementWins() { db.collection('users').doc(currentUser.uid).update({ wins: firebase.firestore.FieldValue.increment(1) }); }
        
        function leaveGame() {
            if(confirm("Spiel verlassen?")) {
                if(gameMode === 'online' && currentGameId) {
                     db.collection('games').doc(currentGameId).update({ status: 'aborted' });
                }
                backToLobby();
            }
        }
        function joinGameByCode() {
            const code = $('#join-id-input').val().trim().toUpperCase(); // Case insensitive
            // Wir suchen das Doc direkt (wir haben die ID als Code genutzt)
            db.collection('games').doc(code).get().then(doc => {
                if(doc.exists && doc.data().status === 'waiting_private') {
                    db.collection('games').doc(code).update({
                         black: currentUser.uid, blackName: userData.username, blackId: userData.displayId, status: 'active'
                    }).then(() => loadOnlineGame(code));
                } else { alert("Raum nicht gefunden oder voll."); }
            });
        }

        // --- AUTH & HELPERS ---
        function registerUserWithId() {
            const email = $('#email-input').val(); const pass = $('#password-input').val(); const name = $('#username-input').val();
            if(!name) return;
            const cRef = db.collection('config').doc('userCounter');
            auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                db.runTransaction(async (t) => {
                    const d = await t.get(cRef); let n = d.exists ? d.data().count + 1 : 1;
                    t.set(cRef, { count: n });
                    t.set(db.collection('users').doc(cred.user.uid), { username: name, displayId: n, uid: cred.user.uid, wins: 0, friends: [] });
                });
            }).catch(e => $('#auth-error').text(e.message));
        }
        function loginUser() { auth.signInWithEmailAndPassword($('#email-input').val(), $('#password-input').val()).catch(e=>$('#auth-error').text(e.message)); }
        function logout() { auth.signOut(); location.reload(); }
        function updateNavUI() { $('#nav-username').text(userData.username); $('#nav-userid').text('#'+userData.displayId); $('#nav-user-area').removeClass('hidden'); }
        function updateLeaderboard() {
            db.collection('users').orderBy('wins', 'desc').limit(10).onSnapshot(s => {
                let h=''; let r=1; s.forEach(d=>{ let u=d.data(); h+=`<div class="d-flex justify-content-between p-2 border-bottom border-dark"><span>#${r} ${u.username}</span><span class="badge bg-secondary">${u.wins||0}</span></div>`; r++; });
                $('#leaderboard-list').html(h);
            });
        }
        function addLog(s) { $('#move-history').append(`<div>${s}</div>`).scrollTop(999); }
        function showScreen(id) { $('.hidden').removeClass('hidden').addClass('hidden'); $('#auth-screen, #lobby-screen, #game-screen').addClass('hidden'); $('#'+id).removeClass('hidden'); }
        function openSettings(){ $('#settings-modal').removeClass('hidden'); }
        function closeSettings(){ $('#settings-modal').addClass('hidden'); }
        function saveSettings(){ 
            const newName = $('#settings-username').val(); 
            if(newName && newName !== userData.username) db.collection('users').doc(currentUser.uid).update({ username: newName });
            closeSettings(); 
        }
    </script>
</body>
</html>
