<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Chess Platform</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #18191a; color: #e4e6eb; font-family: 'Roboto', sans-serif; }
        .app-container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        .card-dark { background-color: #242526; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); margin-bottom: 20px; }
        .btn-primary-custom { background-color: #2D88FF; color: white; font-weight: bold; border: none; }
        .btn-primary-custom:hover { background-color: #1A73E8; color: white; }
        
        .hidden { display: none !important; }
        .id-badge { background: #3a3b3c; color: #b0b3b8; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }

        #board { width: 100%; border: 4px solid #3a3b3c; border-radius: 4px; }
        .board-wrapper { position: relative; max-width: 550px; margin: 0 auto; }
        .board-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content-custom { background: #242526; width: 400px; padding: 20px; border-radius: 10px; border: 1px solid #3a3b3c; }

        .move-log { height: 250px; overflow-y: auto; background: #18191a; padding: 10px; border-radius: 6px; border: 1px solid #3a3b3c; }
        .move-row { padding: 4px; border-bottom: 1px solid #242526; display: flex; justify-content: space-between; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content-custom">
            <h4><i class="fas fa-cog"></i> Einstellungen</h4>
            <hr style="border-color: #444;">
            
            <label class="small text-muted">Benutzernamen ändern</label>
            <input type="text" id="settings-username" class="form-control mb-3" placeholder="Neuer Name">
            
            <label class="small text-muted">Neues Passwort</label>
            <input type="password" id="settings-password" class="form-control mb-3" placeholder="Mind. 6 Zeichen">

            <hr style="border-color: #444;">
            <p class="small text-warning">Admin Zone:</p>
            <button onclick="adminFixUserIds()" class="btn btn-warning btn-sm w-100 mb-3">
                ⚠️ DB Reparieren (IDs vergeben)
            </button>

            <div class="d-flex justify-content-end gap-2">
                <button onclick="closeSettings()" class="btn btn-secondary">Abbrechen</button>
                <button onclick="saveSettings()" class="btn btn-success">Speichern</button>
            </div>
            <div id="settings-msg" class="mt-2 small"></div>
        </div>
    </div>

    <div class="app-container">
        
        <div class="d-flex justify-content-between align-items-center mb-4 p-3 card-dark">
            <h3 class="m-0 fw-bold"><i class="fas fa-chess-king"></i> CHESS PRO</h3>
            <div id="nav-user-area" class="hidden d-flex align-items-center gap-3">
                <div>
                    <span id="nav-username" class="fw-bold text-white">Gast</span>
                    <span id="nav-userid" class="id-badge">#?</span>
                </div>
                <button onclick="openSettings()" class="btn btn-sm btn-outline-light"><i class="fas fa-cog"></i></button>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
            </div>
        </div>

        <div id="auth-screen">
            <div class="card-dark text-center" style="max-width: 400px; margin: 50px auto;">
                <h3>Willkommen</h3>
                <p class="text-muted small">Bitte einloggen oder registrieren</p>
                <input type="email" id="email-input" class="form-control mb-2" placeholder="E-Mail">
                <input type="password" id="password-input" class="form-control mb-3" placeholder="Passwort">
                <input type="text" id="username-input" class="form-control mb-3" placeholder="Username (nur Registrierung)">
                
                <button onclick="loginUser()" class="btn btn-primary-custom w-100 mb-2">Login</button>
                <button onclick="registerUserWithId()" class="btn btn-outline-light w-100">Konto erstellen</button>
                <div id="auth-error" class="text-danger mt-2 small"></div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden">
            <div class="row">
                <div class="col-md-8">
                    <div class="card-dark text-center" style="padding: 50px 20px;">
                        <h1 class="display-4 fw-bold mb-4">Bereit zum Spiel?</h1>
                        <button onclick="findMatch()" id="btn-matchmaking" class="btn btn-primary-custom btn-lg w-100 py-3 mb-4" style="font-size: 1.5em; box-shadow: 0 0 15px rgba(45, 136, 255, 0.5);">
                            <i class="fas fa-play"></i> SPIEL SUCHEN
                        </button>
                        <div class="d-flex justify-content-center gap-2">
                            <input type="text" id="join-id-input" class="form-control" style="max-width: 150px;" placeholder="Code...">
                            <button onclick="joinGameByCode()" class="btn btn-secondary">Code beitreten</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-dark">
                        <h5>Online Spieler</h5>
                        <div id="online-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="row">
                <div class="col-lg-7">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="player-top"><i class="fas fa-user"></i> Gegner</span>
                        <span id="game-status-text" class="badge bg-warning">Warte auf Gegner...</span>
                    </div>
                    <div class="board-wrapper">
                        <div id="board"></div>
                        <div id="wait-overlay" class="board-overlay">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <h4 class="text-white">Suche Gegner...</h4>
                            <p class="text-muted">Teile diesen Code: <span id="game-id-display" class="text-white fw-bold user-select-all"></span></p>
                            <button onclick="leaveGame()" class="btn btn-outline-danger btn-sm mt-3">Abbrechen</button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <span id="player-bottom"><i class="fas fa-user"></i> Du</span>
                    </div>
                </div>
                <div class="col-lg-5 mt-3 mt-lg-0">
                    <div class="card-dark h-100 d-flex flex-column">
                        <h5>Partieverlauf</h5>
                        <div id="move-history" class="move-log flex-grow-1 mb-3"></div>
                        <div id="analysis-display" class="alert alert-dark text-center p-2 mb-2"><small class="text-muted">Analyse Bereich</small></div>
                        <button onclick="leaveGame()" class="btn btn-danger w-100">Spiel verlassen</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqCKRhB87r_r-IgbOd9ESm9MQLKTGwSU0",
            authDomain: "chess-dff93.firebaseapp.com",
            projectId: "chess-dff93",
            storageBucket: "chess-dff93.firebasestorage.app",
            messagingSenderId: "1013706120323",
            appId: "1:1013706120323:web:768c8e77c5f49479150fb6",
            measurementId: "G-SK8BMR8YKF"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let userData = null;
        let game = new Chess();
        let board = null;
        let currentGameId = null;
        let myColor = 'w';
        let gameListener = null;

        // --- 2. AUTH ---
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        userData = doc.data();
                        updateNavUI();
                        showScreen('lobby-screen');
                        updateOnlineStatus();
                    } else {
                        // Falls User Auth hat, aber kein DB Doc (sollte nicht passieren, aber zur Sicherheit)
                        $('#auth-error').text("Benutzerdaten fehlen. Bitte neu registrieren oder Admin kontaktieren.");
                    }
                });
            } else {
                showScreen('auth-screen');
            }
        });

        // REGISTRIERUNG MIT ID (Transaktion)
        function registerUserWithId() {
            const email = $('#email-input').val();
            const password = $('#password-input').val();
            const username = $('#username-input').val();
            if(!username) return $('#auth-error').text("Bitte Name eingeben.");

            const counterRef = db.collection('config').doc('userCounter');

            // Erst Auth, dann DB
            auth.createUserWithEmailAndPassword(email, password).then(cred => {
                const uid = cred.user.uid;
                
                db.runTransaction(async (t) => {
                    const cDoc = await t.get(counterRef);
                    let nextId = 1;
                    if(cDoc.exists) nextId = cDoc.data().count + 1;
                    
                    t.set(counterRef, { count: nextId });
                    t.set(db.collection('users').doc(uid), {
                        username: username,
                        displayId: nextId,
                        uid: uid,
                        email: email,
                        wins: 0,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }).then(() => {
                    // Success handled by onAuthStateChanged
                });
            }).catch(e => $('#auth-error').text(e.message));
        }

        function loginUser() {
            auth.signInWithEmailAndPassword($('#email-input').val(), $('#password-input').val())
                .catch(e => $('#auth-error').text(e.message));
        }
        function logout() { auth.signOut(); location.reload(); }

        function updateNavUI() {
            if(userData) {
                $('#nav-username').text(userData.username);
                $('#nav-userid').text('#' + (userData.displayId || 'NEW'));
                $('#nav-user-area').removeClass('hidden');
            }
        }

        function updateOnlineStatus() {
            db.collection('users').doc(currentUser.uid).update({ 
                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'online' 
            });
            db.collection('users').orderBy('lastSeen', 'desc').limit(10).onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="p-2 border-bottom border-secondary small">
                        <span class="text-success">●</span> ${d.username} <span class="text-muted">#${d.displayId || '?'}</span>
                    </div>`;
                });
                $('#online-list').html(html);
            });
        }

        // --- 3. SETTINGS & ADMIN FIX ---
        function openSettings() {
            if(userData) $('#settings-username').val(userData.username);
            $('#settings-modal').removeClass('hidden');
        }
        function closeSettings() { $('#settings-modal').addClass('hidden'); }

        function saveSettings() {
            const newName = $('#settings-username').val();
            const newPass = $('#settings-password').val();
            const msg = $('#settings-msg');

            if(newName && newName !== userData.username) {
                db.collection('users').doc(currentUser.uid).update({ username: newName })
                .then(() => msg.text("Name gespeichert.").addClass("text-success"));
            }
            if(newPass) {
                currentUser.updatePassword(newPass).then(() => {
                    msg.text("Passwort & Name gespeichert.").addClass("text-success");
                }).catch(error => msg.text(error.message).addClass("text-danger"));
            }
        }

        // --- DER FIX FÜR ALTE USER ---
        async function adminFixUserIds() {
            const btn = $(event.target);
            btn.prop('disabled', true).text('Arbeite...');
            
            try {
                // 1. Zähler holen
                const counterRef = db.collection('config').doc('userCounter');
                const countDoc = await counterRef.get();
                let currentCount = countDoc.exists ? countDoc.data().count : 0;
                
                // 2. Alle User holen
                const usersSnap = await db.collection('users').get();
                const batch = db.batch();
                let updates = 0;

                usersSnap.docs.forEach(doc => {
                    // Wenn KEINE displayId existiert
                    if (!doc.data().displayId) {
                        currentCount++;
                        updates++;
                        batch.update(doc.ref, { displayId: currentCount });
                    }
                });

                if (updates > 0) {
                    // Counter auch updaten
                    batch.set(counterRef, { count: currentCount });
                    await batch.commit();
                    alert(`Erfolg! ${updates} alten Nutzern wurde eine ID gegeben. Der Zähler ist jetzt bei ${currentCount}.`);
                } else {
                    alert("Alles sauber! Alle Nutzer haben bereits eine ID.");
                }
            } catch (e) {
                alert("Fehler: " + e.message);
            }
            btn.prop('disabled', false).text('⚠️ DB Reparieren (IDs vergeben)');
        }

        // --- 4. MATCHMAKING ---
        async function findMatch() {
            $('#btn-matchmaking').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Suche...');
            try {
                const snapshot = await db.collection('games').where('status', '==', 'waiting').limit(1).get();
                let foundGame = null;
                snapshot.forEach(doc => {
                    if(doc.data().white !== currentUser.uid) foundGame = doc;
                });

                if (foundGame) {
                    await db.collection('games').doc(foundGame.id).update({
                        black: currentUser.uid,
                        blackName: userData.username,
                        blackId: userData.displayId,
                        status: 'active'
                    });
                    loadGame(foundGame.id, 'b');
                } else {
                    const newGameRef = db.collection('games').doc();
                    await newGameRef.set({
                        white: currentUser.uid,
                        whiteName: userData.username,
                        whiteId: userData.displayId,
                        black: null,
                        fen: 'start', turn: 'w', status: 'waiting',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    loadGame(newGameRef.id, 'w');
                }
            } catch (error) {
                alert("Fehler bei der Suche.");
                $('#btn-matchmaking').prop('disabled', false).text('SPIEL SUCHEN');
            }
        }

        function joinGameByCode() {
            const code = $('#join-id-input').val().trim();
            if(!code) return;
            db.collection('games').doc(code).get().then(doc => {
                if(doc.exists && doc.data().status === 'waiting') {
                    db.collection('games').doc(code).update({
                         black: currentUser.uid, blackName: userData.username, blackId: userData.displayId, status: 'active'
                    }).then(() => loadGame(code, 'b'));
                } else { alert("Spiel nicht gefunden/voll."); }
            });
        }

        // --- 5. GAME ENGINE ---
        function loadGame(id, color) {
            currentGameId = id;
            myColor = color;
            $('#game-id-display').text(id);
            showScreen('game-screen');
            game = new Chess();
            $('#move-history').empty();
            
            const config = {
                draggable: true, position: 'start', orientation: myColor === 'w' ? 'white' : 'black',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDragStart: onDragStart, onDrop: onDrop, onSnapEnd: () => board.position(game.fen())
            };
            board = Chessboard('board', config);

            if(gameListener) gameListener();
            gameListener = db.collection('games').doc(id).onSnapshot(doc => {
                const data = doc.data();
                if(!data) return;

                const wName = `${data.whiteName} (#${data.whiteId})`;
                const bName = data.blackName ? `${data.blackName} (#${data.blackId})` : "Warte...";
                
                if(myColor === 'w') {
                    $('#player-bottom').text("Du (Weiß)");
                    $('#player-top').text(bName + " (Schwarz)");
                } else {
                    $('#player-bottom').text("Du (Schwarz)");
                    $('#player-top').text(wName + " (Weiß)");
                }

                if(data.status === 'active') {
                    $('#wait-overlay').addClass('hidden');
                    $('#game-status-text').removeClass('bg-warning').addClass('bg-success').text('Spiel läuft');
                }

                if(data.fen && data.fen !== game.fen()) {
                    game.load(data.fen);
                    board.position(data.fen);
                    if(data.lastMoveSan) addLog(data.lastMoveSan);
                }
            });
        }

        function onDragStart(source, piece) {
            if($('#wait-overlay').is(':visible')) return false;
            if(game.game_over()) return false;
            if(game.turn() !== myColor) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) || 
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            db.collection('games').doc(currentGameId).update({
                fen: game.fen(), turn: game.turn(), lastMoveSan: move.san
            });
            addLog(move.san);
        }

        function addLog(san) {
            $('#move-history').append(`<div class="move-row"><span>${san}</span></div>`);
            $('#move-history').scrollTop(9999);
            let msg = "Guter Zug.";
            if(san.includes('#')) msg = "MATT !! Brillant!";
            else if(san.includes('+')) msg = "Schach! Stark.";
            $('#analysis-display').text(msg);
        }

        function leaveGame() {
            if(gameListener) gameListener();
            showScreen('lobby-screen');
            $('#btn-matchmaking').prop('disabled', false).text('SPIEL SUCHEN');
        }

        function showScreen(id) {
            $('#auth-screen, #lobby-screen, #game-screen').addClass('hidden');
            $('#' + id).removeClass('hidden');
        }
    </script>
</body>
</html>
