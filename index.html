<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schach Masters Global</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #1e1e2e; color: #cdd6f4; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Roblox-Style Container */
        .app-container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        /* Karten Design */
        .card-custom { background-color: #313244; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: none; padding: 20px; margin-bottom: 20px; }
        
        .hidden { display: none !important; }
        
        /* Schachbrett */
        #board { width: 100%; max-width: 500px; margin: 0 auto; border: 5px solid #45475a; border-radius: 4px; }
        
        /* Overlay wenn man auf Gegner wartet */
        .board-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 1.5rem; font-weight: bold;
            z-index: 1000;
            border-radius: 4px;
        }
        .board-wrapper { position: relative; max-width: 500px; margin: 0 auto; }

        /* Buttons */
        .btn-roblox { background-color: #00b06f; color: white; font-weight: bold; border: none; box-shadow: 0 4px 0 #008c59; transition: all 0.1s; }
        .btn-roblox:active { transform: translateY(4px); box-shadow: none; }
        .btn-roblox:hover { background-color: #00c980; color: white; }

        .friend-item { background: #45475a; padding: 10px; margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .online-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online-dot.active { background-color: #00b06f; box-shadow: 0 0 5px #00b06f; }

        .user-tag { color: #89b4fa; font-weight: bold; }
        .error-msg { color: #f38ba8; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 style="font-weight: 800;"><i class="fas fa-chess-knight"></i> RO-CHESS</h2>
            <div id="user-info-header" class="hidden">
                <span id="header-username" class="me-3 user-tag">gast</span>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
            </div>
        </div>

        <div id="auth-screen">
            <div class="card-custom text-center" style="max-width: 400px; margin: 50px auto;">
                <h3>Willkommen zurück!</h3>
                <p class="text-muted">Melde dich an, um zu spielen.</p>
                
                <input type="email" id="email-input" class="form-control mb-2" placeholder="E-Mail">
                <input type="password" id="password-input" class="form-control mb-3" placeholder="Passwort">
                <input type="text" id="username-input" class="form-control mb-3" placeholder="Username (nur bei Registrierung)">

                <button onclick="loginUser()" class="btn btn-roblox w-100 mb-2">Einloggen</button>
                <button onclick="registerUser()" class="btn btn-outline-light w-100">Konto erstellen</button>
                
                <div id="auth-error" class="error-msg"></div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden">
            <div class="row">
                <div class="col-md-7">
                    <div class="card-custom text-center">
                        <h4><i class="fas fa-play-circle"></i> Spielen</h4>
                        <br>
                        <button onclick="startGlobalMatchmaking()" class="btn btn-roblox btn-lg w-100 py-3 mb-3">
                            <i class="fas fa-globe"></i> SCHNELLES SPIEL (RANDOM)
                        </button>
                        
                        <div class="text-muted mb-2">- ODER -</div>
                        
                        <button onclick="createPrivateGame()" class="btn btn-outline-primary w-100 mb-2">Privates Spiel erstellen</button>
                        <div class="input-group mt-2">
                            <input type="text" id="join-game-id" class="form-control" placeholder="Spiel-ID eingeben">
                            <button onclick="joinGameById()" class="btn btn-secondary">Beitreten</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="card-custom">
                        <h4><i class="fas fa-user-friends"></i> Freunde</h4>
                        <div class="input-group mb-3">
                            <input type="text" id="friend-name-input" class="form-control form-control-sm" placeholder="Username...">
                            <button onclick="addFriend()" class="btn btn-sm btn-info">Add</button>
                        </div>
                        <div id="friend-list-container" style="max-height: 300px; overflow-y: auto;">
                            <p class="text-muted small text-center">Noch keine Freunde hinzugefügt.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="row">
                <div class="col-md-8">
                    <div class="d-flex justify-content-between mb-2 px-3">
                        <span id="player-black" style="font-size: 1.1em;"><i class="fas fa-user"></i> Schwarz: ...</span>
                        <div id="game-status-badge" class="badge bg-warning text-dark">Warte...</div>
                    </div>

                    <div class="board-wrapper">
                        <div id="board"></div>
                        <div id="wait-overlay" class="board-overlay">
                            <div>
                                <i class="fas fa-spinner fa-spin"></i><br>
                                Warte auf Spieler...
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-2 px-3">
                        <span id="player-white" style="font-size: 1.1em;"><i class="fas fa-user"></i> Weiß: ...</span>
                    </div>
                </div>

                <div class="col-md-4 mt-3 mt-md-0">
                    <div class="card-custom h-100">
                        <h5>Spiel Info</h5>
                        <p id="turn-display" class="alert alert-info">Weiß beginnt</p>
                        <p class="small text-muted">Spiel ID: <span id="current-game-id-display" class="text-white user-select-all"></span></p>
                        <hr>
                        <button onclick="leaveGame()" class="btn btn-danger w-100">Verlassen</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // --- FIREBASE CONFIG (Deine Daten) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqCKRhB87r_r-IgbOd9ESm9MQLKTGwSU0",
            authDomain: "chess-dff93.firebaseapp.com",
            projectId: "chess-dff93",
            storageBucket: "chess-dff93.firebasestorage.app",
            messagingSenderId: "1013706120323",
            appId: "1:1013706120323:web:768c8e77c5f49479150fb6",
            measurementId: "G-SK8BMR8YKF"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- GLOBALE VARIABLEN ---
        let currentUser = null;
        let currentUsername = "Unbekannt";
        let currentGameId = null;
        let myColor = null; 
        let game = new Chess();
        let board = null;
        let gameListener = null;
        let isGameActive = false; // Erst true wenn beide Spieler da sind

        // ----------------------------------------------------
        // 1. AUTH & USER MANAGEMENT
        // ----------------------------------------------------
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if(doc.exists) {
                        currentUsername = doc.data().username;
                        document.getElementById('header-username').innerText = currentUsername;
                        document.getElementById('user-info-header').classList.remove('hidden');
                        loadFriendsList();
                        showScreen('lobby-screen');
                        
                        // Set status online
                        db.collection("users").doc(user.uid).update({ status: 'online' });
                    }
                });
            } else {
                showScreen('auth-screen');
                document.getElementById('user-info-header').classList.add('hidden');
            }
        });

        function registerUser() {
            const email = $('#email-input').val();
            const password = $('#password-input').val();
            const username = $('#username-input').val();
            
            if(!username) return $('#auth-error').text("Bitte Username wählen!");

            auth.createUserWithEmailAndPassword(email, password).then((cred) => {
                db.collection("users").doc(cred.user.uid).set({
                    username: username,
                    email: email,
                    uid: cred.user.uid,
                    friends: [], // Leere Freundesliste
                    status: 'online'
                });
            }).catch(e => $('#auth-error').text(e.message));
        }

        function loginUser() {
            const email = $('#email-input').val();
            const password = $('#password-input').val();
            auth.signInWithEmailAndPassword(email, password).catch(e => $('#auth-error').text(e.message));
        }

        function logout() {
            auth.signOut();
            location.reload();
        }

        // ----------------------------------------------------
        // 2. FREUNDE SYSTEM
        // ----------------------------------------------------
        function addFriend() {
            const friendName = $('#friend-name-input').val().trim();
            if(!friendName) return;

            // 1. User suchen
            db.collection("users").where("username", "==", friendName).get().then(snapshot => {
                if(snapshot.empty) {
                    alert("Benutzer nicht gefunden!");
                } else {
                    const friendData = snapshot.docs[0].data();
                    if(friendData.uid === currentUser.uid) return alert("Du kannst dich nicht selbst adden.");
                    
                    // 2. Zu meiner Liste hinzufügen
                    db.collection("users").doc(currentUser.uid).update({
                        friends: firebase.firestore.FieldValue.arrayUnion({
                            uid: friendData.uid,
                            username: friendData.username
                        })
                    }).then(() => {
                        $('#friend-name-input').val('');
                        loadFriendsList();
                    });
                }
            });
        }

        function loadFriendsList() {
            db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
                const data = doc.data();
                const list = $('#friend-list-container');
                list.empty();

                if(data.friends && data.friends.length > 0) {
                    data.friends.forEach(friend => {
                        list.append(`
                            <div class="friend-item">
                                <span><i class="fas fa-user"></i> ${friend.username}</span>
                                <span class="badge bg-secondary">Freund</span>
                            </div>
                        `);
                    });
                } else {
                    list.html('<p class="text-muted small text-center">Keine Freunde.</p>');
                }
            });
        }

        // ----------------------------------------------------
        // 3. MATCHMAKING (GLOBAL & PRIVAT)
        // ----------------------------------------------------
        
        // A. Random Matchmaking Logik
        async function startGlobalMatchmaking() {
            // 1. Suche nach einem Spiel, das "waiting" ist UND noch keinen schwarzen Spieler hat
            const snapshot = await db.collection("games")
                .where("status", "==", "waiting")
                .where("black", "==", null)
                .limit(1)
                .get();

            if (!snapshot.empty) {
                // -> Spiel gefunden! Wir treten bei.
                const gameDoc = snapshot.docs[0];
                // Checken ob wir es nicht selbst erstellt haben
                if(gameDoc.data().white === currentUser.uid) {
                     alert("Du wartest bereits in einem Spiel!");
                     enterGame(gameDoc.id, 'w');
                     return;
                }

                const gameId = gameDoc.id;
                console.log("Globales Spiel gefunden: " + gameId);
                
                await db.collection("games").doc(gameId).update({
                    black: currentUser.uid,
                    joinerName: currentUsername,
                    status: "active" // Jetzt geht das Spiel los!
                });
                
                enterGame(gameId, 'b');

            } else {
                // -> Kein Spiel gefunden. Wir erstellen eins.
                console.log("Kein Spiel gefunden, erstelle neues...");
                createPrivateGame(true); // true = ist public
            }
        }

        // B. Spiel erstellen
        function createPrivateGame(isGlobal = false) {
            const gameId = Math.random().toString(36).substring(2, 8);
            
            db.collection("games").doc(gameId).set({
                creatorId: currentUser.uid,
                creatorName: currentUsername,
                white: currentUser.uid,
                black: null, // Noch leer
                joinerName: null,
                fen: "start",
                turn: "w",
                status: "waiting", // Wichtig für Matchmaking
                isGlobal: isGlobal
            }).then(() => {
                enterGame(gameId, 'w');
            });
        }

        // C. Per ID beitreten
        function joinGameById() {
            const id = $('#join-game-id').val().trim();
            if(!id) return;
            
            db.collection("games").doc(id).get().then(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    if(data.status === "waiting" && data.black === null) {
                        db.collection("games").doc(id).update({
                            black: currentUser.uid,
                            joinerName: currentUsername,
                            status: "active"
                        }).then(() => enterGame(id, 'b'));
                    } else if (data.white === currentUser.uid) {
                        enterGame(id, 'w'); // Rejoin als Host
                    } else if (data.black === currentUser.uid) {
                        enterGame(id, 'b'); // Rejoin als Gast
                    } else {
                        alert("Spiel voll oder läuft schon.");
                    }
                }
            });
        }

        // ----------------------------------------------------
        // 4. SPIEL LOGIK & DISPLAY
        // ----------------------------------------------------

        function enterGame(id, color) {
            currentGameId = id;
            myColor = color;
            $('#current-game-id-display').text(id);
            showScreen('game-screen');
            
            initBoard();
            listenToGame();
        }

        function initBoard() {
            game = new Chess();
            var config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                orientation: (myColor === 'w') ? 'white' : 'black',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' // Bilder Fix
            };
            board = Chessboard('board', config);
        }

        function listenToGame() {
            gameListener = db.collection("games").doc(currentGameId).onSnapshot(doc => {
                if(!doc.exists) return;
                const data = doc.data();

                // UI Updates
                $('#player-white').html('<i class="fas fa-user"></i> Weiß: ' + data.creatorName);
                $('#player-black').html('<i class="fas fa-user"></i> Schwarz: ' + (data.joinerName || "..."));

                // PRÜFUNG: SIND BEIDE DA?
                if (data.status === "active" && data.white && data.black) {
                    isGameActive = true;
                    $('#wait-overlay').addClass('hidden'); // Overlay weg
                    $('#game-status-badge').removeClass('bg-warning').addClass('bg-success').text('Läuft');
                } else {
                    isGameActive = false;
                    $('#wait-overlay').removeClass('hidden'); // Overlay zeigen
                    $('#game-status-badge').addClass('bg-warning').removeClass('bg-success').text('Warte auf Gegner...');
                }

                // Brett Sync
                if(data.fen && data.fen !== game.fen()) {
                    game.load(data.fen);
                    board.position(data.fen);
                    updateStatusDisplay();
                }
            });
        }

        // --- ZUG LOGIK ---
        function onDragStart(source, piece) {
            // 1. SPIEL MUSS AKTIV SEIN (beide Spieler da)
            if (!isGameActive) return false;

            // 2. Standard Regeln
            if (game.game_over()) return false;
            if (game.turn() !== myColor) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        function onDrop(source, target) {
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            // Update Firebase
            db.collection("games").doc(currentGameId).update({
                fen: game.fen(),
                turn: game.turn()
            });
            updateStatusDisplay();
        }

        function onSnapEnd() { board.position(game.fen()); }

        function updateStatusDisplay() {
            let statusText = "";
            const moveColor = (game.turn() === 'w') ? 'Weiß' : 'Schwarz';

            if (game.in_checkmate()) {
                statusText = "Matt! " + moveColor + " verliert.";
                $('#turn-display').removeClass('alert-info').addClass('alert-danger');
            } else if (game.in_draw()) {
                statusText = "Remis.";
            } else {
                if(game.turn() === myColor) {
                    statusText = "DU bist am Zug!";
                    $('#turn-display').removeClass('alert-secondary').addClass('alert-info');
                } else {
                    statusText = "Gegner überlegt...";
                    $('#turn-display').removeClass('alert-info').addClass('alert-secondary');
                }
            }
            $('#turn-display').text(statusText);
        }

        function leaveGame() {
            if(confirm("Spiel wirklich verlassen?")) {
                if(gameListener) gameListener();
                showScreen('lobby-screen');
                currentGameId = null;
                isGameActive = false;
            }
        }

        function showScreen(id) {
            $('#auth-screen, #lobby-screen, #game-screen').addClass('hidden');
            $('#' + id).removeClass('hidden');
        }

    </script>
</body>
</html>
