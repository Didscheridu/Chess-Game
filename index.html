<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Mein Online Schach</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: sans-serif; background-color: #222; color: #eee; display: flex; flex-direction: column; align-items: center; }
        h1 { margin-bottom: 10px; }
        #board { width: 400px; margin-bottom: 10px; }
        .info { margin-top: 10px; color: #aaa; font-size: 0.9em; text-align: center;}
        #status { font-weight: bold; color: #ffcc00; }
    </style>
</head>
<body>

    <h1>♟️ Schach: Du gegen die Welt</h1>
    <div id="board"></div>
    <div>Status: <span id="status">Verbinde...</span></div>
    <div class="info">
        Schick den Link einem Freund. <br>
        Wenn einer zieht, sieht es der andere sofort!
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // --- DEINE KONFIGURATION (Habe ich bereits eingefügt) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqCKRhB87r_r-IgbOd9ESm9MQLKTGwSU0",
            authDomain: "chess-dff93.firebaseapp.com",
            projectId: "chess-dff93",
            storageBucket: "chess-dff93.firebasestorage.app",
            messagingSenderId: "1013706120323",
            appId: "1:1013706120323:web:768c8e77c5f49479150fb6",
            measurementId: "G-SK8BMR8YKF"
        };

        // Firebase starten
        firebase.initializeApp(firebaseConfig);
        
        // Datenbank starten
        const db = firebase.firestore();
        
        // Wir speichern das Spiel im Ordner "spiele", Dokument "livegame"
        const gameDocRef = db.collection("spiele").doc("livegame");

        // --- SCHACH LOGIK ---
        var game = new Chess();
        var board = null;
        var $status = $('#status');

        function onDragStart (source, piece) {
            if (game.game_over()) return false;
            // Nur erlauben, wenn man für die Farbe zieht, die dran ist
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        function onDrop (source, target) {
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q' 
            });

            if (move === null) return 'snapback';

            // WICHTIG: Zug an Firebase senden!
            saveGameToFirebase();
            updateStatus();
        }

        function onSnapEnd () {
            board.position(game.fen());
        }

        function updateStatus () {
            var status = '';
            var moveColor = (game.turn() === 'w') ? 'Weiß' : 'Schwarz';

            if (game.in_checkmate()) {
                status = 'Matt! ' + moveColor + ' hat verloren.';
            } else if (game.in_draw()) {
                status = 'Remis!';
            } else {
                status = moveColor + ' ist am Zug';
                if (game.in_check()) status += ' (Schach!)';
            }
            $status.html(status);
        }

        var config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd
        };
        board = Chessboard('board', config);

        // --- FIREBASE SYNC (Das Herzstück) ---

        // 1. Senden
        function saveGameToFirebase() {
            gameDocRef.set({
                fen: game.fen(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).catch((error) => {
                console.error("Fehler:", error);
                alert("Fehler beim Speichern. Hast du die Datenbank erstellt?");
            });
        }

        // 2. Empfangen (Live!)
        gameDocRef.onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                // Wenn der Server einen neuen Stand hat, übernehmen wir ihn
                if (game.fen() !== data.fen) {
                    console.log("Neuer Zug vom Gegner!");
                    game.load(data.fen);
                    board.position(data.fen);
                    updateStatus();
                }
            }
        });

        updateStatus();
    </script>
</body>
</html>
