<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Masters Pro - Click & Move</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #18191a; color: #e4e6eb; font-family: 'Roboto', sans-serif; }
        .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .card-dark { background-color: #242526; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid #333; }
        .btn-primary-custom { background-color: #2D88FF; color: white; font-weight: bold; border: none; }
        .btn-primary-custom:hover { background-color: #1A73E8; color: white; }
        
        .hidden { display: none !important; }
        .id-badge { background: #3a3b3c; color: #b0b3b8; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }

        #board { width: 100%; border: 4px solid #3a3b3c; border-radius: 4px; user-select: none; }
        .board-wrapper { position: relative; max-width: 550px; margin: 0 auto; }
        
        /* Queue Overlay */
        #queue-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(36, 37, 38, 0.95); z-index: 500;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            border-radius: 10px;
        }
        .pulse-ring {
            border: 4px solid #2D88FF; border-radius: 50%; height: 60px; width: 60px;
            animation: pulsate 2s infinite; margin-bottom: 20px;
        }
        @keyframes pulsate { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

        /* End Screen Overlay */
        #end-screen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999; /* Sehr hoch, damit es über allem liegt */
            display: flex; justify-content: center; align-items: center;
        }
        .end-card { background: #242526; padding: 40px; border-radius: 20px; text-align: center; border: 2px solid #444; min-width: 300px; }
        .win-title { font-size: 3rem; font-weight: 900; color: #2ecc71; text-shadow: 0 0 20px rgba(46, 204, 113, 0.5); }
        .lose-title { font-size: 3rem; font-weight: 900; color: #e74c3c; text-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .modal-content-custom { background: #242526; width: 400px; padding: 20px; border-radius: 10px; border: 1px solid #3a3b3c; }

        .move-log { height: 250px; overflow-y: auto; background: #18191a; padding: 10px; border-radius: 6px; }

        /* --- STYLES FÜR PUNKTE (CLICK SYSTEM) --- */
        .highlight-dot {
            background-color: rgba(45, 136, 255, 0.8);
            width: 25%;
            height: 25%;
            border-radius: 50%;
            position: absolute;
            top: 37.5%;
            left: 37.5%;
            pointer-events: none; /* Wichtig: Klick muss durch den Punkt auf das Feld gehen */
        }
        .highlight-square {
            box-shadow: inset 0 0 3px 3px rgba(255, 255, 0, 0.5);
        }
        /* Wenn man auf eine Figur klickt (Mauszeiger) */
        .square-55d63 { cursor: pointer; }
    </style>
</head>
<body>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content-custom">
            <h4>Einstellungen</h4>
            <input type="text" id="settings-username" class="form-control mb-3" placeholder="Neuer Name">
            <input type="password" id="settings-password" class="form-control mb-3" placeholder="Neues Passwort">
            <button onclick="adminFixUserIds()" class="btn btn-warning btn-sm w-100 mb-3">⚠️ Admin: IDs reparieren</button>
            <div class="d-flex justify-content-end gap-2">
                <button onclick="closeSettings()" class="btn btn-secondary">Abbrechen</button>
                <button onclick="saveSettings()" class="btn btn-success">Speichern</button>
            </div>
            <div id="settings-msg" class="mt-2 small"></div>
        </div>
    </div>

    <div id="end-screen-overlay" class="hidden">
        <div class="end-card">
            <div id="end-title" class="win-title">SIEG!</div>
            <p id="end-reason" class="text-muted my-3">...</p>
            <button onclick="backToLobby()" class="btn btn-light btn-lg w-100 fw-bold">Zurück zur Lobby</button>
        </div>
    </div>

    <div class="app-container">
        
        <div class="d-flex justify-content-between align-items-center mb-4 p-3 card-dark">
            <h3 class="m-0 fw-bold"><i class="fas fa-chess"></i> CHESS PRO</h3>
            <div id="nav-user-area" class="hidden d-flex align-items-center gap-3">
                <div>
                    <span id="nav-username" class="fw-bold text-white">Gast</span>
                    <span id="nav-userid" class="id-badge">#?</span>
                </div>
                <button onclick="openSettings()" class="btn btn-sm btn-outline-light"><i class="fas fa-cog"></i></button>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
            </div>
        </div>

        <div id="auth-screen">
            <div class="card-dark text-center" style="max-width: 400px; margin: 50px auto;">
                <h3>Login</h3>
                <input type="email" id="email-input" class="form-control mb-2" placeholder="E-Mail">
                <input type="password" id="password-input" class="form-control mb-3" placeholder="Passwort">
                <input type="text" id="username-input" class="form-control mb-3" placeholder="Username (nur Registrierung)">
                <button onclick="loginUser()" class="btn btn-primary-custom w-100 mb-2">Login</button>
                <button onclick="registerUserWithId()" class="btn btn-outline-light w-100">Konto erstellen</button>
                <div id="auth-error" class="text-danger mt-2 small"></div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden">
            <div class="row">
                <div class="col-md-7">
                    <div class="card-dark text-center" style="padding: 40px 20px; position: relative; min-height: 400px;">
                        
                        <div id="queue-overlay" class="hidden">
                            <div class="pulse-ring"></div>
                            <h3>Suche Gegner...</h3>
                            <p class="text-muted">Du bist in der Warteschlange.</p>
                            <p class="small text-muted" id="queue-time">Wartezeit: 0s</p>
                            <button onclick="leaveQueue()" class="btn btn-outline-danger mt-3">Abbrechen</button>
                        </div>

                        <h1 class="fw-bold mb-4">Bereit?</h1>
                        <button onclick="joinQueue()" id="btn-matchmaking" class="btn btn-primary-custom btn-lg w-100 py-4 mb-4" style="font-size: 1.5em; box-shadow: 0 0 15px rgba(45, 136, 255, 0.5);">
                            <i class="fas fa-play"></i> SPIEL SUCHEN
                        </button>
                        
                        <hr>
                        <div class="d-flex justify-content-center gap-2 mt-3">
                            <input type="text" id="join-id-input" class="form-control" style="max-width: 150px;" placeholder="Code eingeben...">
                            <button onclick="joinGameByCode()" class="btn btn-secondary">Beitreten</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-5">
                    <div class="card-dark">
                        <h5 class="text-warning"><i class="fas fa-trophy"></i> Top Wins</h5>
                        <div id="leaderboard-list" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="row">
                <div class="col-lg-7">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="player-top"><i class="fas fa-user"></i> Gegner</span>
                        <span id="game-status-text" class="badge bg-success">Spiel läuft</span>
                    </div>
                    
                    <div class="board-wrapper">
                        <div id="board"></div>
                    </div>

                    <div class="mt-2">
                        <span id="player-bottom"><i class="fas fa-user"></i> Du</span>
                    </div>
                </div>

                <div class="col-lg-5 mt-3 mt-lg-0">
                    <div class="card-dark h-100 d-flex flex-column">
                        <h5>Verlauf</h5>
                        <div id="move-history" class="move-log flex-grow-1 mb-3"></div>
                        <button onclick="leaveGame()" class="btn btn-danger w-100">Aufgeben / Verlassen</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqCKRhB87r_r-IgbOd9ESm9MQLKTGwSU0",
            authDomain: "chess-dff93.firebaseapp.com",
            projectId: "chess-dff93",
            storageBucket: "chess-dff93.firebasestorage.app",
            messagingSenderId: "1013706120323",
            appId: "1:1013706120323:web:768c8e77c5f49479150fb6",
            measurementId: "G-SK8BMR8YKF"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let userData = null;
        let game = new Chess();
        let board = null;
        let currentGameId = null;
        let myColor = 'w';
        let gameListener = null;
        let queueListener = null;
        let queueTimerInterval = null;

        // CLICK SYSTEM VARIABLEN
        let selectedSquare = null; // Welches Feld wurde angeklickt?

        // --- 2. AUTH & INIT ---
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        userData = doc.data();
                        updateNavUI();
                        showScreen('lobby-screen');
                        updateLeaderboard();
                        checkQueueStatus();
                    }
                });
            } else {
                showScreen('auth-screen');
            }
        });

        // --- 3. QUEUE SYSTEM ---
        function joinQueue() {
            if(!userData) return;
            showQueueUI();
            const queueRef = db.collection('queue').doc(currentUser.uid);
            queueRef.set({
                uid: currentUser.uid, username: userData.username, displayId: userData.displayId,
                joinedAt: firebase.firestore.FieldValue.serverTimestamp(), gameId: null
            }).then(() => {
                attemptMatchmaking();
                listenToMyQueueEntry();
            });
        }

        async function attemptMatchmaking() {
            try {
                const snapshot = await db.collection('queue').orderBy('joinedAt', 'asc').limit(2).get();
                if (snapshot.size >= 2) {
                    const p1 = snapshot.docs[0].data();
                    const p2 = snapshot.docs[1].data();
                    await db.runTransaction(async (t) => {
                        const newGameRef = db.collection('games').doc();
                        t.update(db.collection('queue').doc(p1.uid), { gameId: newGameRef.id });
                        t.update(db.collection('queue').doc(p2.uid), { gameId: newGameRef.id });
                        t.set(newGameRef, {
                            white: p1.uid, whiteName: p1.username, whiteId: p1.displayId,
                            black: p2.uid, blackName: p2.username, blackId: p2.displayId,
                            fen: 'start', turn: 'w', status: 'active', result: null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                }
            } catch (e) { console.log(e); }
        }

        function listenToMyQueueEntry() {
            if(queueListener) queueListener();
            queueListener = db.collection('queue').doc(currentUser.uid).onSnapshot(doc => {
                if(doc.exists && doc.data().gameId) {
                    loadGame(doc.data().gameId);
                    db.collection('queue').doc(currentUser.uid).delete();
                } else if(!doc.exists) hideQueueUI();
            });
        }

        function leaveQueue() {
            db.collection('queue').doc(currentUser.uid).delete();
            hideQueueUI();
        }

        function checkQueueStatus() {
            db.collection('queue').doc(currentUser.uid).get().then(doc => {
                if(doc.exists) {
                    if(doc.data().gameId) {
                        loadGame(doc.data().gameId);
                        db.collection('queue').doc(currentUser.uid).delete();
                    } else {
                        showQueueUI();
                        listenToMyQueueEntry();
                        attemptMatchmaking();
                    }
                }
            });
        }

        function showQueueUI() {
            $('#queue-overlay').removeClass('hidden');
            let s = 0; if(queueTimerInterval) clearInterval(queueTimerInterval);
            queueTimerInterval = setInterval(() => { s++; $('#queue-time').text(`Wartezeit: ${s}s`); }, 1000);
        }
        function hideQueueUI() {
            $('#queue-overlay').addClass('hidden');
            if(queueTimerInterval) clearInterval(queueTimerInterval);
            if(queueListener) queueListener();
        }


        // --- 4. GAME ENGINE MIT CLICK SYSTEM ---
        function loadGame(id) {
            currentGameId = id;
            hideQueueUI();
            showScreen('game-screen');
            $('#end-screen-overlay').addClass('hidden'); // Fix für hängenden Screen

            game = new Chess();
            $('#move-history').empty();
            selectedSquare = null; // Reset selection

            // Board Init - WICHTIG: draggable: false
            board = Chessboard('board', {
                position: 'start',
                draggable: false, // KEIN DRAG MEHR
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });

            // Klick Event Listener hinzufügen
            // Wir nutzen jQuery um Klicks auf die Felder abzufangen
            $('#board').off('click').on('click', '.square-55d63', handleSquareClick);

            if(gameListener) gameListener();
            
            gameListener = db.collection('games').doc(id).onSnapshot(doc => {
                const data = doc.data();
                if(!data) return; 

                // Farbe setzen
                if (data.white === currentUser.uid) myColor = 'w';
                else if (data.black === currentUser.uid) myColor = 'b';
                
                // UI Namen
                if(myColor === 'w') {
                    $('#player-bottom').text(`Du (Weiß)`);
                    $('#player-top').text(`${data.blackName} (Schwarz)`);
                    board.orientation('white');
                } else {
                    $('#player-bottom').text(`Du (Schwarz)`);
                    $('#player-top').text(`${data.whiteName} (Weiß)`);
                    board.orientation('black');
                }

                if(data.status === 'aborted') {
                    showEndScreen('GEWONNEN!', 'Gegner hat aufgegeben.', 'win');
                    return;
                }

                if(data.fen && data.fen !== game.fen()) {
                    game.load(data.fen);
                    board.position(data.fen);
                    removeHighlights(); // Markierungen entfernen bei neuem Zug
                    if(data.lastMoveSan) addLog(data.lastMoveSan);
                }

                if (data.result) handleGameEnd(data.result);
            });
        }

        // --- DAS NEUE KLICK-SYSTEM ---
        function handleSquareClick(e) {
            // Spiel muss laufen
            if(game.game_over() || game.turn() !== myColor) return;

            // Das geklickte Feld ermitteln (z.B. "e2")
            const square = $(this).attr('data-square');

            // 1. Haben wir schon eine Figur ausgewählt?
            if (selectedSquare) {
                // Ja -> Versuch einen Zug zu machen
                const move = game.move({
                    from: selectedSquare,
                    to: square,
                    promotion: 'q' // Immer Dame
                });

                if (move) {
                    // GÜLTIGER ZUG!
                    makeMove(move);
                    selectedSquare = null;
                    removeHighlights();
                } else {
                    // Ungültiger Zug -> Ist es vielleicht eine andere eigene Figur?
                    // Wenn ja, wähle diese aus. Wenn nein, Auswahl aufheben.
                    const piece = game.get(square);
                    if (piece && piece.color === myColor) {
                        selectedSquare = square;
                        highlightPossibleMoves(square);
                    } else {
                        selectedSquare = null;
                        removeHighlights();
                    }
                }
            } else {
                // Nein -> Figur auswählen
                const piece = game.get(square);
                if (piece && piece.color === myColor) {
                    selectedSquare = square;
                    highlightPossibleMoves(square);
                }
            }
        }

        function highlightPossibleMoves(square) {
            removeHighlights();
            
            // Eigenes Feld markieren
            $(`.square-${square}`).addClass('highlight-square');

            // Mögliche Züge holen
            const moves = game.moves({ square: square, verbose: true });
            
            if (moves.length === 0) return;

            // Punkte zeichnen
            moves.forEach(move => {
                // Punkt in das div des Feldes einfügen
                $(`.square-${move.to}`).append('<div class="highlight-dot"></div>');
            });
        }

        function removeHighlights() {
            $('.square-55d63').removeClass('highlight-square');
            $('.highlight-dot').remove();
        }

        function makeMove(move) {
            // Firebase Update
            let result = null;
            let status = 'active';

            if (game.game_over()) {
                if (game.in_checkmate()) {
                    result = game.turn() === 'w' ? 'b' : 'w'; 
                    incrementWins();
                } else if (game.in_draw()) {
                    result = 'draw';
                }
                status = 'finished';
            }

            db.collection('games').doc(currentGameId).update({
                fen: game.fen(), turn: game.turn(), lastMoveSan: move.san,
                result: result, status: status
            });
            board.position(game.fen());
            addLog(move.san);
        }

        // --- END SCREEN LOGIC (FIXED) ---
        function handleGameEnd(result) {
            if (result === 'draw') showEndScreen('REMIS', 'Unentschieden.', 'draw');
            else if (result === myColor) showEndScreen('GEWONNEN!', 'Du hast gewonnen.', 'win');
            else showEndScreen('VERLOREN', 'Schachmatt.', 'lose');
        }

        function showEndScreen(title, reason, type) {
            $('#end-screen-overlay').removeClass('hidden'); // Zeigen
            $('#end-title').text(title);
            $('#end-reason').text(reason);
            $('#end-title').removeClass('win-title lose-title draw-title');
            if(type === 'win') $('#end-title').addClass('win-title');
            if(type === 'lose') $('#end-title').addClass('lose-title');
            if(type === 'draw') $('#end-title').addClass('draw-title');
        }

        // FIX FÜR DEN "VERLASSEN" BUTTON
        function backToLobby() {
            if(gameListener) gameListener();
            // Overlay erzwingen auszublenden
            $('#end-screen-overlay').addClass('hidden');
            showScreen('lobby-screen');
        }

        function incrementWins() {
            db.collection('users').doc(currentUser.uid).update({ wins: firebase.firestore.FieldValue.increment(1) });
        }

        function leaveGame() {
            if(confirm("Aufgeben?")) {
                if(currentGameId) db.collection('games').doc(currentGameId).update({ status: 'aborted' });
                backToLobby();
            }
        }
        
        // --- HELPER & AUTH ---
        function registerUserWithId() {
            const email = $('#email-input').val(); const pass = $('#password-input').val(); const name = $('#username-input').val();
            if(!name) return;
            const cRef = db.collection('config').doc('userCounter');
            auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                db.runTransaction(async (t) => {
                    const d = await t.get(cRef); let n = d.exists ? d.data().count + 1 : 1;
                    t.set(cRef, { count: n });
                    t.set(db.collection('users').doc(cred.user.uid), { username: name, displayId: n, uid: cred.user.uid, wins: 0 });
                });
            }).catch(e => $('#auth-error').text(e.message));
        }
        function loginUser() { auth.signInWithEmailAndPassword($('#email-input').val(), $('#password-input').val()).catch(e=>$('#auth-error').text(e.message)); }
        function logout() { auth.signOut(); location.reload(); }
        function updateNavUI() { $('#nav-username').text(userData.username); $('#nav-userid').text('#'+userData.displayId); $('#nav-user-area').removeClass('hidden'); }
        function updateLeaderboard() {
            db.collection('users').orderBy('wins', 'desc').limit(10).onSnapshot(s => {
                let h=''; let r=1; s.forEach(d=>{ let u=d.data(); h+=`<div class="d-flex justify-content-between p-2 border-bottom border-dark"><span>#${r} ${u.username}</span><span class="badge bg-secondary">${u.wins||0}</span></div>`; r++; });
                $('#leaderboard-list').html(h);
            });
        }
        function addLog(s) { $('#move-history').append(`<div>${s}</div>`).scrollTop(999); }
        function showScreen(id) { $('.hidden').removeClass('hidden').addClass('hidden'); $('#auth-screen, #lobby-screen, #game-screen').addClass('hidden'); $('#'+id).removeClass('hidden'); }
        function joinGameByCode() { /* ... */ }
        function openSettings(){ $('#settings-modal').removeClass('hidden'); }
        function closeSettings(){ $('#settings-modal').addClass('hidden'); }
        function saveSettings(){ /* ... */ closeSettings(); }
        async function adminFixUserIds() { /* ... */ }
    </script>
</body>
</html>
