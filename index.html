<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Masters: Pro Edition</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #18191a; color: #e4e6eb; font-family: 'Roboto', sans-serif; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* Fullscreen Loader */
        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #18191a; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        .card-dark { background-color: #242526; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid #333; position: relative; }
        
        /* Board & Pieces */
        #board { width: 100%; border: 4px solid #3a3b3c; border-radius: 4px; user-select: none; }
        .board-wrapper { position: relative; max-width: 550px; margin: 0 auto; }
        .piece-417db { transition: top 0.2s ease-out, left 0.2s ease-out !important; z-index: 50; }

        /* FX System */
        #fx-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: visible; }
        .kill-effect { position: absolute; display: flex; justify-content: center; align-items: center; font-size: 4rem; animation: pop-fade 0.8s forwards; text-shadow: 0 0 15px black; z-index: 110; }
        @keyframes pop-fade { 0% { transform: scale(0.5); opacity: 0; } 40% { transform: scale(1.3); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        .projectile { position: absolute; font-size: 3rem; z-index: 200; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: flex; justify-content: center; align-items: center; }
        .modal-content-custom { background: #242526; width: 500px; padding: 20px; border-radius: 10px; border: 1px solid #3a3b3c; max-height: 90vh; overflow-y: auto; text-align: center; }

        /* Admin & UI */
        .btn-admin { background: #e74c3c; color: white; font-weight: bold; border: none; }
        .coin-display { background: #f1c40f; color: #000; padding: 5px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .legal-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #111; padding: 10px; text-align: center; font-size: 0.8rem; z-index: 100; border-top: 1px solid #333; }
        
        /* Animations */
        @keyframes hacker-glitch-anim { 0% { transform: translate(0); } 20% { transform: translate(-1px, 1px); clip-path: inset(5% 0 5% 0); } 40% { transform: translate(1px, -1px); clip-path: inset(0 5% 0 5%); } 100% { transform: translate(0); clip-path: inset(0 0 0 0); } }
        @keyframes angel-float-anim { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        
        .wing-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 45; display: flex; justify-content: center; }
        .wing-left, .wing-right { font-size: 2rem; color: white; position: absolute; top: -5px; animation: flap 0.6s infinite alternate; }
        .wing-left { left: -10px; transform: scaleX(-1); } .wing-right { right: -10px; }
        @keyframes flap { from { transform: rotate(0deg); } to { transform: rotate(20deg); } }
    </style>
</head>
<body>

    <div id="app-loader">
        <div class="spinner-border text-primary mb-3"></div>
        <h4>Lade Chess Masters...</h4>
    </div>

    <style id="dynamic-skin-styles"></style>
    <div id="global-win-fx" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:1; pointer-events:none; display:none;"></div>

    <div id="auth-screen" class="hidden">
        <div class="card-dark text-center" style="max-width: 400px; margin: 100px auto;">
            <h2 class="fw-bold mb-4">Login</h2>
            <div id="auth-error" class="alert alert-danger hidden"></div>
            <input id="email-input" class="form-control mb-2" placeholder="E-Mail">
            <input id="password-input" type="password" class="form-control mb-3" placeholder="Passwort">
            <input id="username-input" class="form-control mb-3" placeholder="Username (nur Registrierung)">
            <button onclick="loginUser()" class="btn btn-primary w-100 mb-2">Anmelden</button>
            <button onclick="registerUser()" class="btn btn-outline-light w-100">Konto erstellen</button>
        </div>
    </div>

    <div id="lobby-screen" class="hidden">
        <div class="app-container">
            <div class="d-flex justify-content-between align-items-center mb-4 p-3 card-dark">
                <h3 class="m-0 fw-bold">CHESS MASTERS</h3>
                <div class="d-flex align-items-center">
                    <button id="admin-btn" onclick="openAdminPanel()" class="btn btn-admin me-3 hidden">ADMIN</button>
                    <div class="coin-display me-3" onclick="openShop()"><i class="fas fa-coins"></i> <span id="nav-coins">0</span></div>
                    <div class="me-3 text-warning">Wins: <span id="nav-wins">0</span> üèÜ</div>
                    <div class="text-end me-3">
                        <span id="nav-username" class="fw-bold">...</span><br>
                        <small id="nav-userid" class="text-muted">#?</small>
                    </div>
                    <button onclick="logout()" class="btn btn-sm btn-outline-danger"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card-dark text-center" style="padding: 60px 20px;">
                        <button onclick="startQueue()" class="btn btn-primary btn-lg w-100 mb-3 p-4">RANKED MATCH</button>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><button onclick="startBotGame()" class="btn btn-warning w-100 p-3">VS BOT</button></div>
                            <div class="col-6"><button onclick="showPrivateMenu()" class="btn btn-info w-100 p-3">PRIVAT</button></div>
                        </div>
                        <button onclick="openShop()" class="btn btn-outline-warning w-100">SKIN SHOP</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-dark">
                        <h5>üèÜ Rangliste</h5>
                        <div id="leaderboard-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="app-container">
            <div class="row">
                <div class="col-lg-8">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="opponent-name">Gegner</span>
                        <button id="god-mode-btn" onclick="toggleGodMode()" class="btn btn-sm btn-danger hidden">GOD MODE</button>
                    </div>
                    <div class="board-wrapper">
                        <div id="board"></div>
                        <div id="fx-overlay"></div>
                    </div>
                    <div class="mt-2"><span id="own-name">Du</span></div>
                </div>
                <div class="col-lg-4">
                    <div class="card-dark h-100 d-flex flex-column">
                        <h5>Verlauf</h5>
                        <div id="move-history" style="flex-grow:1; background:#111; padding:10px; border-radius:5px; height:300px; overflow-y:auto;"></div>
                        <button onclick="leaveGame()" class="btn btn-danger w-100 mt-3">Spiel verlassen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay hidden"><div class="modal-content-custom" style="width:600px;"><h3>Admin Panel</h3><div class="input-group mb-3"><input id="admin-search" class="form-control" placeholder="ID"><button onclick="adminLoadUser()" class="btn btn-light">Load</button></div><div id="admin-user-box" class="hidden text-start"><p id="adm-name"></p><input id="adm-coins" type="number" class="form-control mb-2" placeholder="Coins"><button onclick="adminSetVal('coins')" class="btn btn-success btn-sm mb-3">Set Coins</button><input id="adm-displayId" type="number" class="form-control mb-2" placeholder="ID Nachtragen"><button onclick="adminSetVal('displayId')" class="btn btn-primary btn-sm mb-3">Set ID</button><br><button onclick="adminBan()" class="btn btn-danger btn-sm">BAN USER</button></div><button onclick="closeModal('admin-modal')" class="btn btn-secondary w-100 mt-3">Close</button></div></div>
    <div id="shop-modal" class="modal-overlay hidden"><div class="modal-content-custom"><h3>Skin Shop</h3><div id="skin-list" class="row g-2"></div><button onclick="closeModal('shop-modal')" class="btn btn-secondary w-100 mt-3">Close</button></div></div>
    <div id="promotion-modal" class="modal-overlay hidden"><div class="modal-content-custom"><h4>W√§hle Figur</h4><div class="d-flex justify-content-center gap-2"><button onclick="promo('q')" class="btn btn-light btn-lg">‚ôï</button><button onclick="promo('r')" class="btn btn-light btn-lg">‚ôñ</button><button onclick="promo('b')" class="btn btn-light btn-lg">‚ôó</button><button onclick="promo('n')" class="btn btn-light btn-lg">‚ôò</button></div></div></div>

    <div class="legal-footer">
        <a onclick="alert('Impressum hier')">Impressum</a> | <a onclick="alert('DSGVO hier')">Datenschutz</a>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBqCKRhB87r_r-IgbOd9ESm9MQLKTGwSU0", authDomain: "chess-dff93.firebaseapp.com", projectId: "chess-dff93", storageBucket: "chess-dff93.firebasestorage.app", messagingSenderId: "1013706120323", appId: "1:1013706120323:web:768c8e77c5f49479150fb6" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        const SKINS = {
            'default': { name: 'Klassisch', price: 0, filter: 'none', anim: '' },
            'fire': { name: 'Inferno', price: 100, filter: 'sepia(1) saturate(8) hue-rotate(-50deg)', anim: 'üí•' },
            'admin_gold': { name: 'GOLD', adminOnly: true, filter: 'brightness(1.2) sepia(1) saturate(5)', anim: 'üëë' },
            'admin_hacker': { name: 'HACKER', adminOnly: true, filter: 'contrast(1.5) drop-shadow(0 0 2px white)', anim: 'üíª', glitch: true },
            'admin_angel': { name: 'ANGEL', adminOnly: true, filter: 'brightness(1.5)', anim: 'üëº', wings: true },
            'admin_football': { name: 'FOOTBALL', adminOnly: true, filter: 'drop-shadow(0 0 2px white)', anim: '‚öΩ', projectile: true }
        };

        let currentUser = null, userData = null, game = new Chess(), board = null, currentGameId = null, gameMode = 'lobby';
        let currentWhiteSkin = 'default', currentBlackSkin = 'default', wingsInterval = null, pendingMove = null;

        // --- AUTH LOGIC ---
        auth.onAuthStateChanged(user => {
            $('#app-loader').addClass('hidden');
            if (user) {
                currentUser = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        userData = doc.data();
                        if (userData.banned) { auth.signOut(); location.reload(); return; }
                        
                        // ID 1 & 2 ADMIN
                        const isAdmin = (userData.displayId === 1 || userData.displayId === 2);
                        if (isAdmin) $('#admin-btn, #god-mode-btn').removeClass('hidden');

                        updateNav();
                        
                        // Only auto-load online game if we are NOT in a bot game
                        if (gameMode !== 'bot' && userData.activeGameId && userData.activeGameId !== currentGameId) {
                            loadOnlineGame(userData.activeGameId);
                        } else if (!userData.activeGameId && gameMode === 'lobby') {
                            showScreen('lobby-screen');
                        }
                    }
                });
            } else {
                showScreen('auth-screen');
            }
        });

        function showScreen(id) {
            $('#auth-screen, #lobby-screen, #game-screen').addClass('hidden');
            $(`#${id}`).removeClass('hidden');
        }

        function updateNav() {
            $('#nav-coins').text(userData.coins || 0);
            $('#nav-wins').text(userData.wins || 0);
            $('#nav-username').text(userData.username);
            $('#nav-userid').text('#' + userData.displayId);
        }

        // --- GAME CORE ---
        function startBotGame() {
            gameMode = 'bot';
            showScreen('game-screen');
            currentWhiteSkin = userData.equippedSkin || 'default';
            currentBlackSkin = 'default';
            initBoard();
            updateSkins();
        }

        function loadOnlineGame(id) {
            gameMode = 'online';
            currentGameId = id;
            showScreen('game-screen');
            db.collection('games').doc(id).onSnapshot(doc => {
                if (!doc.exists) return;
                const data = doc.data();
                currentWhiteSkin = data.whiteSkin;
                currentBlackSkin = data.blackSkin;
                const myColor = (data.white === currentUser.uid) ? 'w' : 'b';
                
                if (data.fen !== game.fen()) {
                    const t = new Chess(game.fen());
                    const m = t.move(data.lastMoveSan);
                    if (m && m.captured) handleFX(m);
                    game.load(data.fen);
                    board.position(data.fen, true);
                }
                updateSkins();
                board.orientation(myColor === 'w' ? 'white' : 'black');
                if (data.result) alert("Spiel Ende: " + data.result);
            });
            initBoard();
        }

        function initBoard() {
            game = new Chess();
            board = Chessboard('board', {
                position: 'start',
                draggable: false,
                moveSpeed: 200,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
            $('#board').off('click').on('click', '.square-55d63', handleSquareClick);
        }

        function handleSquareClick() {
            const sq = $(this).attr('data-square');
            const myTurnColor = (gameMode === 'bot') ? 'w' : (currentGameId ? (game.turn()) : 'w');
            
            if (pendingMove) {
                const move = game.move({ from: pendingMove, to: sq, promotion: 'q' });
                if (move) {
                    // Promotion check
                    if (move.piece === 'p' && (sq[1] === '8' || sq[1] === '1')) {
                        game.undo();
                        $('#promotion-modal').removeClass('hidden');
                        pendingMove = { from: pendingMove, to: sq };
                        return;
                    }
                    game.undo();
                    makeMove(pendingMove, sq, 'q');
                    pendingMove = null;
                } else {
                    pendingMove = sq;
                }
            } else {
                if (game.get(sq)) pendingMove = sq;
            }
        }

        function makeMove(from, to, promo) {
            const move = game.move({ from, to, promotion: promo });
            if (move) {
                if (move.captured) handleFX(move);
                board.position(game.fen(), true);
                if (gameMode === 'online') {
                    db.collection('games').doc(currentGameId).update({
                        fen: game.fen(),
                        lastMoveSan: move.san,
                        turn: game.turn()
                    });
                } else {
                    setTimeout(botMove, 500);
                }
            }
        }

        function botMove() {
            const moves = game.moves();
            if (moves.length === 0) return;
            game.move(moves[Math.floor(Math.random() * moves.length)]);
            board.position(game.fen(), true);
        }

        function handleFX(move) {
            const skinKey = (move.color === 'w') ? currentWhiteSkin : currentBlackSkin;
            const skin = SKINS[skinKey];
            if (!skin || skinKey === 'default') return;

            const $sq = $(`.square-${move.to}`);
            const pos = $sq.position();
            const el = $(`<div class="kill-effect" style="top:${pos.top}px; left:${pos.left}px; width:${$sq.width()}px; height:${$sq.height()}px;">${skin.anim}</div>`);
            $('#fx-overlay').append(el);
            setTimeout(() => el.remove(), 1000);
        }

        function updateSkins() {
            const sW = SKINS[currentWhiteSkin] || SKINS['default'];
            const sB = SKINS[currentBlackSkin] || SKINS['default'];
            let css = `img[src*="/w"] { filter: ${sW.filter}; ${sW.glitch ? 'animation: hacker-glitch-anim 0.3s infinite;' : ''} }`;
            css += `img[src*="/b"] { filter: ${sB.filter}; ${sB.glitch ? 'animation: hacker-glitch-anim 0.3s infinite;' : ''} }`;
            $('#dynamic-skin-styles').html(css);
            
            if (wingsInterval) clearInterval(wingsInterval);
            wingsInterval = setInterval(() => {
                $('.wing-container').remove();
                if (sW.wings) $('img[src*="/w"]').parent().append('<div class="wing-container"><div class="wing-left">ü™Ω</div><div class="wing-right">ü™Ω</div></div>');
                if (sB.wings) $('img[src*="/b"]').parent().append('<div class="wing-container"><div class="wing-left">ü™Ω</div><div class="wing-right">ü™Ω</div></div>');
            }, 500);
        }

        // --- AUTH HELPERS ---
        function loginUser() { auth.signInWithEmailAndPassword($('#email-input').val(), $('#password-input').val()); }
        function logout() { auth.signOut(); location.reload(); }
        function registerUser() {
            const name = $('#username-input').val();
            auth.createUserWithEmailAndPassword($('#email-input').val(), $('#password-input').val()).then(cred => {
                db.collection('users').doc(cred.user.uid).set({
                    username: name, wins: 0, coins: 0, displayId: Math.floor(Math.random() * 1000), inventory: ['default'], equippedSkin: 'default'
                });
            });
        }
        function closeModal(id) { $(`#${id}`).addClass('hidden'); }
    </script>
</body>
</html>
