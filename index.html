<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Masters: Elemental Wars</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #18191a; color: #e4e6eb; font-family: 'Roboto', sans-serif; }
        .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .card-dark { background-color: #242526; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid #333; }
        .btn-primary-custom { background-color: #2D88FF; color: white; font-weight: bold; border: none; }
        .btn-primary-custom:hover { background-color: #1A73E8; color: white; }
        
        .hidden { display: none !important; }
        .id-badge { background: #3a3b3c; color: #b0b3b8; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }

        #board { width: 100%; border: 4px solid #3a3b3c; border-radius: 4px; user-select: none; position: relative; }
        .board-wrapper { position: relative; max-width: 550px; margin: 0 auto; }
        
        /* Overlays */
        #queue-overlay, #end-screen-overlay, .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .modal-content-custom { background: #242526; width: 500px; padding: 20px; border-radius: 10px; border: 1px solid #3a3b3c; position: relative; max-height: 90vh; overflow-y: auto; }

        /* Notifications & UI */
        .notification-bell { position: relative; cursor: pointer; font-size: 1.2rem; margin-right: 15px; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; justify-content: center; align-items: center; }
        .notif-item { background: #3a3b3c; padding: 10px; border-radius: 5px; margin-bottom: 5px; font-size: 0.9em; text-align: left; }
        .friend-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #333; cursor: pointer; }
        .friend-item:hover { background: #3a3b3c; }
        .best-friend { color: #f1c40f; text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); } 
        .win-title { color: #2ecc71; font-size: 3rem; font-weight: 900; }
        .lose-title { color: #e74c3c; font-size: 3rem; font-weight: 900; }
        
        /* Click System */
        .highlight-dot { background-color: rgba(45, 136, 255, 0.8); width: 25%; height: 25%; border-radius: 50%; position: absolute; top: 37.5%; left: 37.5%; pointer-events: none; }
        .highlight-square { box-shadow: inset 0 0 3px 3px rgba(255, 255, 0, 0.5); }
        .square-55d63 { cursor: pointer; }

        /* --- SHOP & SKINS --- */
        .coin-display { background: #f1c40f; color: #000; padding: 5px 12px; border-radius: 20px; font-weight: bold; margin-right: 15px; box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); cursor: pointer; }
        .skin-card { background: #333; border-radius: 8px; padding: 10px; margin-bottom: 10px; text-align: center; border: 2px solid transparent; transition: 0.2s; }
        .skin-card:hover { transform: translateY(-2px); }
        .skin-card.owned { border-color: #2ecc71; }
        .skin-card.active { border-color: #2D88FF; box-shadow: 0 0 15px rgba(45, 136, 255, 0.4); }
        .skin-preview { width: 30px; height: 30px; display: inline-block; margin: 2px; border-radius: 4px; }
        
        /* KILL ANIMATIONS */
        .kill-effect {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            display: flex; justify-content: center; align-items: center;
            font-size: 4rem; pointer-events: none; z-index: 1000;
            animation: pop-fade 0.8s forwards; text-shadow: 0 0 10px black;
        }
        @keyframes pop-fade { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        /* SKIN FILTERS (Dynamisch via JS gesteuert, aber hier Basisklassen) */
        /* Wir manipulieren img Tags direkt im Brett */
    </style>
</head>
<body>

    <style id="dynamic-skin-styles"></style>

    <div id="shop-modal" class="modal-overlay hidden">
        <div class="modal-content-custom">
            <h3 class="fw-bold mb-3"><i class="fas fa-store"></i> Skin Shop</h3>
            <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-dark rounded">
                <span>Dein Guthaben:</span>
                <span class="text-warning fw-bold fs-4"><i class="fas fa-coins"></i> <span id="shop-coins">0</span></span>
            </div>
            <div id="skin-list" class="row g-2">
                </div>
            <button onclick="closeModal('shop-modal')" class="btn btn-secondary w-100 mt-3">Schlie√üen</button>
        </div>
    </div>

    <div id="queue-overlay" class="hidden">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem;"></div>
            <h2 class="fw-bold pulse">Suche Gegner...</h2>
            <p class="text-muted" id="queue-timer">Zeit: 0s</p>
            <button onclick="leaveQueue()" class="btn btn-outline-danger mt-4 px-5 rounded-pill">Abbrechen</button>
        </div>
    </div>

    <div id="notif-modal" class="modal-overlay hidden">
        <div class="modal-content-custom">
            <h4>Benachrichtigungen</h4><div id="notif-list" style="max-height: 300px; overflow-y: auto;"></div>
            <button onclick="closeModal('notif-modal')" class="btn btn-secondary w-100 mt-3">Schlie√üen</button>
        </div>
    </div>
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal-content-custom text-center">
            <div style="width:80px;height:80px;background:#2D88FF;border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:2rem;"><i class="fas fa-user"></i></div>
            <h3 id="profile-name">User</h3><p class="text-muted" id="profile-id">#0</p><hr><div id="profile-actions" class="d-grid gap-2"></div>
            <button onclick="closeModal('profile-modal')" class="btn btn-outline-secondary mt-3 w-100">Schlie√üen</button>
        </div>
    </div>
    <div id="private-menu-modal" class="modal-overlay hidden">
        <div class="modal-content-custom">
            <h3>Privates Spiel</h3>
            <div class="d-grid gap-3 mt-4"><button onclick="openPrivateCreate()" class="btn btn-primary btn-lg">Erstellen</button><button onclick="openPrivateJoin()" class="btn btn-outline-light btn-lg">Beitreten</button></div>
            <button onclick="closeModal('private-menu-modal')" class="btn btn-link mt-3">Abbrechen</button>
        </div>
    </div>
    <div id="private-create-modal" class="modal-overlay hidden">
        <div class="modal-content-custom"><h4>Warte auf Spieler...</h4><div id="host-code-display" class="fw-bold fs-1 bg-dark p-2 rounded mb-3">...</div><button onclick="cancelPrivateHost()" class="btn btn-danger w-100">Abbrechen</button></div>
    </div>
    <div id="private-join-modal" class="modal-overlay hidden">
        <div class="modal-content-custom"><h4>Code eingeben</h4><input id="private-join-input" class="form-control text-center mb-3"><button onclick="submitPrivateJoin()" class="btn btn-success w-100">Go</button><button onclick="closeModal('private-join-modal')" class="btn btn-secondary w-100 mt-2">Abbrechen</button></div>
    </div>
    <div id="end-screen-overlay" class="hidden">
        <div class="modal-content-custom text-center">
            <div id="end-title" class="win-title">SIEG!</div><div id="end-reward" class="fs-4 text-warning my-2 fw-bold"></div><p id="end-reason" class="text-muted">...</p><button onclick="backToLobby()" class="btn btn-light btn-lg w-100 fw-bold">Zur√ºck zur Lobby</button>
        </div>
    </div>

    <div class="app-container">
        <div class="d-flex justify-content-between align-items-center mb-4 p-3 card-dark">
            <h3 class="m-0 fw-bold"><i class="fas fa-chess"></i> CHESS MASTERS</h3>
            <div id="nav-user-area" class="hidden d-flex align-items-center">
                <div class="coin-display" onclick="openShop()"><i class="fas fa-coins"></i> <span id="nav-coins">0</span></div>
                <div class="notification-bell" onclick="openNotifModal()"><i class="fas fa-bell"></i><div id="bell-badge" class="notification-badge hidden">0</div></div>
                <div class="me-3 text-end"><div class="fw-bold text-white"><span id="nav-username">Gast</span></div><div class="small text-muted">ID: <span id="nav-userid">#?</span></div></div>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div id="auth-screen">
            <div class="card-dark text-center" style="max-width: 400px; margin: 50px auto;">
                <h3>Login</h3>
                <input id="email-input" class="form-control mb-2" placeholder="E-Mail">
                <input id="password-input" type="password" class="form-control mb-3" placeholder="Passwort">
                <input id="username-input" class="form-control mb-3" placeholder="Username (Registrierung)">
                <button onclick="loginUser()" class="btn btn-primary-custom w-100 mb-2">Login</button>
                <button onclick="registerUserWithId()" class="btn btn-outline-light w-100">Konto erstellen</button>
            </div>
        </div>

        <div id="lobby-screen" class="hidden">
            <div class="row">
                <div class="col-md-7">
                    <div class="card-dark text-center" style="padding: 40px 20px; min-height: 400px;">
                        <h2 class="fw-bold mb-4">Bereit?</h2>
                        <button onclick="joinRankedQueue()" class="btn btn-primary-custom btn-lg w-100 p-4 mb-3"><i class="fas fa-globe"></i> RANKED MATCH</button>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><button onclick="startBotGame()" class="btn btn-warning w-100 p-3 fw-bold"><i class="fas fa-robot"></i> VS BOT</button></div>
                            <div class="col-6"><button onclick="showPrivateMenu()" class="btn btn-info w-100 p-3 fw-bold"><i class="fas fa-user-secret"></i> PRIVAT</button></div>
                        </div>
                        <button onclick="openShop()" class="btn btn-outline-warning w-100"><i class="fas fa-store"></i> SKIN SHOP</button>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card-dark">
                        <h5>Freunde</h5>
                        <div class="input-group mb-3"><input type="number" id="friend-id-input" class="form-control" placeholder="ID"><button onclick="sendFriendRequest()" class="btn btn-outline-info">Add</button></div>
                        <div id="friends-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="row">
                <div class="col-lg-7">
                    <div class="d-flex justify-content-between mb-2"><span id="player-top">Gegner</span><span id="game-status-text" class="badge bg-success">Spiel l√§uft</span></div>
                    <div class="board-wrapper"><div id="board"></div></div>
                    <div class="mt-2"><span id="player-bottom">Du</span></div>
                </div>
                <div class="col-lg-5 mt-3">
                    <div class="card-dark h-100 d-flex flex-column"><h5>Verlauf</h5><div id="move-history" class="move-log flex-grow-1 mb-3" style="height:250px;overflow-y:auto;background:#222;padding:10px;"></div><button onclick="leaveGame()" class="btn btn-danger w-100">Aufgeben</button></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBqCKRhB87r_r-IgbOd9ESm9MQLKTGwSU0",
            authDomain: "chess-dff93.firebaseapp.com",
            projectId: "chess-dff93",
            storageBucket: "chess-dff93.firebasestorage.app",
            messagingSenderId: "1013706120323",
            appId: "1:1013706120323:web:768c8e77c5f49479150fb6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- SKINS DATABASE ---
        // colorW/B: Hintergrundfarbe der Felder (optional)
        // filter: CSS Filter f√ºr die FIGUREN
        const SKINS = {
            'default': { name: 'Klassisch', price: 0, colorW: '#f0d9b5', colorB: '#b58863', filter: 'none', anim: '' },
            'water': { name: 'Atlantis', price: 50, colorW: '#a8d0e6', colorB: '#374785', filter: 'hue-rotate(180deg) brightness(1.2) contrast(1.2)', anim: 'üåä' },
            'fire': { name: 'Inferno', price: 100, colorW: '#f6c7b6', colorB: '#a31621', filter: 'sepia(1) saturate(5) hue-rotate(-50deg)', anim: 'üí•' },
            'forest': { name: 'Smaragd', price: 200, colorW: '#c8e6c9', colorB: '#2e7d32', filter: 'sepia(1) hue-rotate(80deg) saturate(2)', anim: 'üçÉ' },
            'dark': { name: 'Shadow', price: 500, colorW: '#95a5a6', colorB: '#2c3e50', filter: 'grayscale(100%) contrast(1.5)', anim: 'üíÄ' },
            'gold': { name: 'Midas', price: 1000, colorW: '#f9e79f', colorB: '#b7950b', filter: 'sepia(1) saturate(3) hue-rotate(10deg)', anim: '‚ú®' }
        };

        let currentUser = null, userData = null;
        let game = new Chess(), board = null, myColor = 'w';
        let currentGameId = null, gameMode = 'online';
        let gameListener = null, queueListener = null, notifListener = null, hostListener = null;
        let selectedSquare = null, queueInterval = null, queueTime = 0;
        
        // Skin States f√ºr das aktuelle Spiel
        let currentWhiteSkin = 'default';
        let currentBlackSkin = 'default';

        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        userData = doc.data();
                        // Init Data if missing
                        if(!userData.coins) userData.coins = 0;
                        if(!userData.inventory) userData.inventory = ['default'];
                        if(!userData.equippedSkin) userData.equippedSkin = 'default';
                        
                        updateHeader();
                        loadFriends();
                        listenNotifications();
                        // Refresh Shop UI if open
                        if(!$('#shop-modal').hasClass('hidden')) renderShopUI();

                        // Reconnect
                        if(userData.activeGameId && $('#game-screen').hasClass('hidden')) {
                            db.collection('games').doc(userData.activeGameId).get().then(g => {
                                if(g.exists && g.data().status !== 'finished' && g.data().status !== 'aborted') loadOnlineGame(userData.activeGameId);
                                else { db.collection('users').doc(currentUser.uid).update({activeGameId: null}); showScreen('lobby-screen'); }
                            });
                        } else if (!userData.activeGameId) showScreen('lobby-screen');
                    }
                });
            } else showScreen('auth-screen');
        });

        function updateHeader() {
            $('#nav-username').text(userData.username);
            $('#nav-userid').text(`#${userData.displayId}`);
            $('#nav-coins').text(userData.coins);
            $('#nav-user-area').removeClass('hidden');
        }

        // --- SHOP SYSTEM (Dynamic Refresh) ---
        function openShop() {
            renderShopUI();
            $('#shop-modal').removeClass('hidden');
        }

        function renderShopUI() {
            $('#shop-coins').text(userData.coins);
            const list = $('#skin-list');
            list.empty();
            
            for (const [key, skin] of Object.entries(SKINS)) {
                const owned = userData.inventory.includes(key);
                const active = userData.equippedSkin === key;
                let btnHtml = '';

                if (active) btnHtml = `<button class="btn btn-sm btn-success disabled w-100">Ausger√ºstet</button>`;
                else if (owned) btnHtml = `<button onclick="equipSkin('${key}')" class="btn btn-sm btn-outline-primary w-100">Ausr√ºsten</button>`;
                else btnHtml = `<button onclick="buySkin('${key}')" class="btn btn-sm btn-warning w-100">${skin.price} <i class="fas fa-coins"></i></button>`;

                list.append(`
                    <div class="col-6 col-md-4">
                        <div class="skin-card ${owned?'owned':''} ${active?'active':''}">
                            <h5>${skin.name} <span style="font-size:1.2em">${skin.anim}</span></h5>
                            <div class="d-flex justify-content-center mb-2">
                                <div class="skin-preview" style="background:${skin.colorW}"></div>
                                <div class="skin-preview" style="background:${skin.colorB}"></div>
                            </div>
                            ${btnHtml}
                        </div>
                    </div>
                `);
            }
        }

        function buySkin(key) {
            const skin = SKINS[key];
            if(userData.coins >= skin.price) {
                // UI nicht schlie√üen, nur updaten
                db.collection('users').doc(currentUser.uid).update({
                    coins: firebase.firestore.FieldValue.increment(-skin.price),
                    inventory: firebase.firestore.FieldValue.arrayUnion(key)
                });
            } else alert("Nicht genug Coins!");
        }

        function equipSkin(key) {
            db.collection('users').doc(currentUser.uid).update({ equippedSkin: key });
        }

        // --- VISUALS: SKINS & ANIMATIONS ---
        function updateBoardVisuals() {
            const sW = SKINS[currentWhiteSkin] || SKINS['default'];
            const sB = SKINS[currentBlackSkin] || SKINS['default'];
            
            // 1. BOARD COLORS (User Side Only - Simplified for clarity)
            // Wir nutzen die Farben des Spielers f√ºr das GANZE Brett (damit es gut aussieht)
            // ODER: Wir nutzen Standardfarben, aber f√§rben Figuren.
            // Der User sagte: "nur das halbe brett seine seite den skin hat".
            // Das ist technisch mit chessboard.js CSS extrem schwer.
            // Kompromiss: Das Brett hat die Farbe des EIGENEN Skins. Die Figuren haben individuelle Skins.
            
            const mySkin = (myColor === 'w') ? sW : sB;
            // Falls Zuschauer, nimm Wei√ü
            const boardSkin = (myColor === 'spectator') ? sW : mySkin;

            const styleId = 'dynamic-skin-styles';
            let styleTag = document.getElementById(styleId);
            styleTag.innerHTML = `
                /* Board Colors based on User Skin */
                .white-1e1d7 { background-color: ${boardSkin.colorW} !important; color: ${boardSkin.colorB} !important; }
                .black-3c85d { background-color: ${boardSkin.colorB} !important; color: ${boardSkin.colorW} !important; }
                
                /* PIECE SKINS - Specific Filters for White vs Black pieces */
                /* White Pieces get White Player Skin Filter */
                img[src*="/w"] { filter: ${sW.filter} !important; transition: all 0.3s; }
                
                /* Black Pieces get Black Player Skin Filter */
                img[src*="/b"] { filter: ${sB.filter} !important; transition: all 0.3s; }
            `;
        }

        function triggerKillAnim(square, attackerColor) {
            // Animation h√§ngt vom Skin des ANGREIFERS ab
            const skinKey = (attackerColor === 'w') ? currentWhiteSkin : currentBlackSkin;
            const animChar = SKINS[skinKey].anim;
            
            if(!animChar) return;

            const sqDiv = $(`.square-${square}`);
            // Zuf√§llige leichte Rotation f√ºr Effekt
            const rot = Math.random() * 40 - 20;
            sqDiv.append(`<div class="kill-effect" style="transform: rotate(${rot}deg)">${animChar}</div>`);
            setTimeout(() => $('.kill-effect').remove(), 1000);
        }

        // --- GAME LOGIC ---
        function loadOnlineGame(id) {
            currentGameId = id; gameMode = 'online';
            showScreen('game-screen');
            game = new Chess(); $('#move-history').empty(); selectedSquare = null;
            board = Chessboard('board', {position:'start', draggable:false, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'});
            $('#board').off('click').on('click', '.square-55d63', handleSquareClick);

            if(gameListener) gameListener();
            gameListener = db.collection('games').doc(id).onSnapshot(doc => {
                if(!doc.exists) { db.collection('users').doc(currentUser.uid).update({activeGameId: null}); backToLobby(); return; }
                const data = doc.data();

                // Lade Skins aus DB
                currentWhiteSkin = data.whiteSkin || 'default';
                currentBlackSkin = data.blackSkin || 'default';
                
                if(data.white === currentUser.uid) myColor = 'w'; 
                else if(data.black === currentUser.uid) myColor = 'b';
                else myColor = 'spectator';

                // Update Visuals (Board & Pieces)
                updateBoardVisuals();
                board.orientation(myColor==='b'?'black':'white');

                // UI Text
                const opName = (myColor==='w') ? data.blackName : data.whiteName;
                $('#player-top').text(opName || 'Gegner');
                $('#player-bottom').text("Du");

                // Moves handling
                if(data.fen && data.fen !== game.fen()) {
                    // Check for capture to trigger anim
                    const tempGame = new Chess(game.fen());
                    const move = tempGame.move(data.lastMoveSan);
                    if(move && (move.flags.includes('c') || move.flags.includes('e'))) {
                        // Wer hat geschlagen? Der, der am Zug WAR (also data.turn ist jetzt der andere)
                        // Wenn turn 'w' ist, war 'b' dran.
                        const attacker = (data.turn === 'w') ? 'b' : 'w'; 
                        triggerKillAnim(move.to, attacker);
                    }

                    game.load(data.fen); 
                    board.position(data.fen); 
                    removeHighlights();
                    if(data.lastMoveSan) addLog(data.lastMoveSan);
                }

                if(data.result) showEndScreen(data.result);
                if(data.status === 'aborted') showEndScreen('aborted');
            });
        }

        // --- QUEUE & MATCHMAKING (With Skin Sync) ---
        function joinRankedQueue() {
            $('#queue-overlay').removeClass('hidden');
            queueTime = 0; if(queueInterval) clearInterval(queueInterval);
            queueInterval = setInterval(() => { queueTime++; $('#queue-timer').text(`Zeit: ${queueTime}s`); checkMatchmaking(); }, 2000);
            
            // WICHTIG: Skin mit in die Queue schreiben!
            db.collection('queue').doc(currentUser.uid).set({
                uid: currentUser.uid, 
                username: userData.username, 
                displayId: userData.displayId, 
                joinedAt: firebase.firestore.FieldValue.serverTimestamp(), 
                gameId: null,
                skin: userData.equippedSkin // <--- Skin speichern
            });

            if(queueListener) queueListener();
            queueListener = db.collection('queue').doc(currentUser.uid).onSnapshot(doc => {
                if(doc.exists && doc.data().gameId) {
                    const gid = doc.data().gameId; leaveQueue(false); db.collection('queue').doc(currentUser.uid).delete();
                    db.collection('users').doc(currentUser.uid).update({activeGameId: gid}); loadOnlineGame(gid);
                }
            });
        }

        async function checkMatchmaking() {
            const snap = await db.collection('queue').orderBy('joinedAt', 'asc').limit(2).get();
            if(snap.size >= 2) {
                const p1 = snap.docs[0].data(), p2 = snap.docs[1].data();
                if(p1.uid === currentUser.uid) {
                    const gameRef = db.collection('games').doc();
                    // Skins von beiden Spielern in das Spiel √ºbertragen!
                    await gameRef.set({
                        white: p1.uid, whiteName: p1.username, whiteId: p1.displayId, whiteSkin: p1.skin,
                        black: p2.uid, blackName: p2.username, blackId: p2.displayId, blackSkin: p2.skin,
                        fen: 'start', turn: 'w', status: 'active', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    const b = db.batch(); 
                    b.update(db.collection('queue').doc(p1.uid), {gameId: gameRef.id}); 
                    b.update(db.collection('queue').doc(p2.uid), {gameId: gameRef.id}); 
                    await b.commit();
                }
            }
        }
        function leaveQueue(d=true) { $('#queue-overlay').addClass('hidden'); if(queueInterval) clearInterval(queueInterval); if(queueListener) queueListener(); if(d) db.collection('queue').doc(currentUser.uid).delete(); }

        // --- PRIVATE GAMES (With Skin Sync) ---
        function createPrivateGame() {
            const code = Math.random().toString(36).substring(2,7).toUpperCase();
            // Auch hier Skin speichern
            db.collection('games').doc(code).set({
                white: currentUser.uid, whiteName: userData.username, whiteId: userData.displayId, whiteSkin: userData.equippedSkin,
                status: 'waiting_private', fen: 'start', turn: 'w', createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            $('#host-code-display').text(code); $('#private-create-modal').removeClass('hidden');
            hostListener=db.collection('games').doc(code).onSnapshot(d=>{
                if(d.exists&&d.data().status==='active'){
                    hostListener();closeModal('private-create-modal');
                    db.collection('users').doc(currentUser.uid).update({activeGameId:code});
                    loadOnlineGame(code);
                }
            }); currentGameId=code;
        }
        function submitPrivateJoin() {
            const c=$('#private-join-input').val().trim().toUpperCase();
            db.collection('games').doc(c).get().then(d=>{
                if(d.exists&&d.data().status==='waiting_private'){
                    db.collection('games').doc(c).update({
                        black: currentUser.uid, blackName: userData.username, blackId: userData.displayId, blackSkin: userData.equippedSkin, 
                        status: 'active'
                    }).then(()=>{closeModal('private-join-modal');db.collection('users').doc(currentUser.uid).update({activeGameId:c});loadOnlineGame(c);});
                } else alert("Fehler");
            });
        }

        // --- MOVE & REWARD LOGIC ---
        function handleSquareClick() {
            if(gameMode === 'online' && game.turn() !== myColor) return;
            if(game.game_over()) return;
            const sq = $(this).attr('data-square');
            if(selectedSquare) {
                const move = game.move({from:selectedSquare, to:sq, promotion:'q'});
                if(move) {
                    selectedSquare = null; removeHighlights();
                    // Capture Reward (10 Coins)
                    if(move.captured && gameMode === 'online') {
                        db.collection('users').doc(currentUser.uid).update({coins: firebase.firestore.FieldValue.increment(10)});
                        triggerKillAnim(move.to, myColor);
                    }
                    if(gameMode === 'online') updateGameOnline(move);
                    else { board.position(game.fen()); setTimeout(botMove, 500); }
                } else {
                    selectedSquare = null; removeHighlights();
                    if(game.get(sq) && game.get(sq).color === (gameMode==='bot'?'w':myColor)) { selectedSquare=sq; highlight(sq); }
                }
            } else { if(game.get(sq) && game.get(sq).color === (gameMode==='bot'?'w':myColor)) { selectedSquare=sq; highlight(sq); } }
        }

        function updateGameOnline(move) {
            let res = null;
            if(game.game_over()) {
                if(game.in_checkmate()) { 
                    res = game.turn()==='w'?'b':'w';
                    // Win Reward (50 Coins) + Win Count
                    if(res === myColor) {
                        db.collection('users').doc(currentUser.uid).update({
                            wins: firebase.firestore.FieldValue.increment(1),
                            coins: firebase.firestore.FieldValue.increment(50)
                        });
                    }
                } else res = 'draw';
            }
            db.collection('games').doc(currentGameId).update({fen: game.fen(), turn: game.turn(), lastMoveSan: move.san, result: res});
            board.position(game.fen()); addLog(move.san);
        }

        // --- HELPERS & STANDARD ---
        function highlight(sq) { removeHighlights(); $(`.square-${sq}`).addClass('highlight-square'); game.moves({square:sq, verbose:true}).forEach(m => $(`.square-${m.to}`).append('<div class="highlight-dot"></div>')); }
        function removeHighlights() { $('.square-55d63').removeClass('highlight-square'); $('.highlight-dot').remove(); }
        function showEndScreen(res) {
            $('#end-screen-overlay').removeClass('hidden');
            let txt="SIEG!", c="text-success", r="";
            if(res==='aborted'){txt="GEGNER WEG";c="text-danger";}
            else if(res==='draw'){txt="REMIS";c="text-warning";}
            else if(res!==myColor){txt="VERLOREN";c="text-danger";}
            else r="+50 Coins!";
            $('#end-title').text(txt).removeClass().addClass('win-title '+c); $('#end-reward').text(r);
            db.collection('users').doc(currentUser.uid).update({activeGameId: null});
        }
        function backToLobby() { if(gameListener) gameListener(); $('#end-screen-overlay').addClass('hidden'); db.collection('users').doc(currentUser.uid).update({activeGameId: null}); showScreen('lobby-screen'); }
        function leaveGame() { if(confirm("Verlassen?")) { if(gameMode==='online') db.collection('games').doc(currentGameId).update({status:'aborted'}); backToLobby(); } }
        function startBotGame() { gameMode = 'bot'; currentWhiteSkin = userData.equippedSkin; currentBlackSkin = 'default'; showScreen('game-screen'); updateBoardVisuals(); game = new Chess(); board = Chessboard('board', {position:'start', draggable:false, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'}); $('#board').off('click').on('click', '.square-55d63', handleSquareClick); $('#player-top').text("Bot"); $('#player-bottom').text("Du"); }
        function botMove() { if(game.game_over())return; const moves = game.moves({verbose:true}); const move = moves[Math.floor(Math.random()*moves.length)]; game.move(move.san); board.position(game.fen()); if(move.captured) triggerKillAnim(move.to, 'b'); }
        function registerUserWithId() { const e=$('#email-input').val(), p=$('#password-input').val(), n=$('#username-input').val(); const c=db.collection('config').doc('userCounter'); auth.createUserWithEmailAndPassword(e,p).then(cr=>{ db.runTransaction(async t=>{ const d=await t.get(c); let i=d.exists?d.data().count+1:1; t.set(c,{count:i}); t.set(db.collection('users').doc(cr.user.uid),{username:n,displayId:i,uid:cr.user.uid,wins:0,coins:0,inventory:['default'],equippedSkin:'default',friends:[]}); }); }); }
        function loginUser() { auth.signInWithEmailAndPassword($('#email-input').val(), $('#password-input').val()); }
        function logout() { auth.signOut(); location.reload(); }
        function showScreen(id) { $('.hidden').removeClass('hidden').addClass('hidden'); $('#auth-screen, #lobby-screen, #game-screen').addClass('hidden'); $(`#${id}`).removeClass('hidden'); }
        function closeModal(id) { $(`#${id}`).addClass('hidden'); }
        function openNotifModal() { $('#notif-modal').removeClass('hidden'); }
        function openSettings() { $('#settings-modal').removeClass('hidden'); }
        function addLog(s) { $('#move-history').append(`<div>${s}</div>`).scrollTop(999); }
        // Friend & Notif (Compact)
        function sendFriendRequest() { const i=$('#friend-id-input').val(); if(!i)return; db.collection('users').where('displayId','==',parseInt(i)).get().then(s=>{if(s.empty)return alert("404"); const t=s.docs[0]; db.collection('users').doc(t.id).collection('notifications').add({type:'friend_request',fromUid:currentUser.uid,title:'Anfrage',message:`${userData.username} will Freund sein.`,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>alert("Gesendet"));}); }
        async function loadFriends() { const l=$('#friends-list'); if(!userData.friends||userData.friends.length===0){l.html('<div class="text-center small mt-3">Keine Freunde</div>');return;} const d=await Promise.all(userData.friends.map(u=>db.collection('users').doc(u).get())); l.empty(); d.forEach(o=>{if(!o.exists)return;const f=o.data();if(!f.friends.includes(currentUser.uid))db.collection('users').doc(o.id).update({friends:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});const b=userData.bestFriends&&userData.bestFriends.includes(o.id); l.append(`<div class="friend-item" onclick="openProfile('${o.id}')"><div><i class="fas fa-star ${b?'best-friend':'text-muted'} me-2" onclick="toggleBest(event,'${o.id}')"></i><b>${f.username}</b> <small>#${f.displayId}</small></div>${f.activeGameId?'<span class="badge bg-danger">Spiel</span>':'<i class="fas fa-circle text-success"></i>'}</div>`); }); }
        function toggleBest(e,u){ e.stopPropagation(); let o=userData.bestFriends&&userData.bestFriends.includes(u)?'arrayRemove':'arrayUnion'; db.collection('users').doc(currentUser.uid).update({bestFriends:firebase.firestore.FieldValue[o](u)}); }
        function listenNotifications(){ if(notifListener)notifListener(); notifListener=db.collection('users').doc(currentUser.uid).collection('notifications').orderBy('timestamp','desc').onSnapshot(s=>{ $('#bell-badge').text(s.size).toggleClass('hidden',s.size===0); let h=s.size===0?'<div class="text-center small p-3">Leer</div>':''; s.forEach(d=>{const n=d.data(); h+=`<div class="notif-item"><b>${n.title}</b><div class="small mb-2">${n.message}</div><div class="d-flex gap-2"><button onclick="handleNotif('${d.id}','${n.type}',true,'${n.fromUid}','${n.payload}')" class="btn btn-sm btn-success flex-grow-1">Ja</button><button onclick="handleNotif('${d.id}','${n.type}',false)" class="btn btn-sm btn-secondary">Nein</button></div></div>`;}); $('#notif-list').html(h); }); }
        function handleNotif(id,t,a,f,p){ const r=db.collection('users').doc(currentUser.uid).collection('notifications').doc(id); if(!a){r.delete();return;} if(t==='friend_request'){const b=db.batch(); b.update(db.collection('users').doc(currentUser.uid),{friends:firebase.firestore.FieldValue.arrayUnion(f)}); b.update(db.collection('users').doc(f),{friends:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)}); b.delete(r); b.commit().then(()=>{closeModal('notif-modal');alert("Freund!");}); } else if(t==='game_invite'){ db.collection('games').doc(p).update({black:currentUser.uid,blackName:userData.username,blackId:userData.displayId,blackSkin:userData.equippedSkin,status:'active'}).then(()=>{r.delete();closeModal('notif-modal');db.collection('users').doc(currentUser.uid).update({activeGameId:p});loadOnlineGame(p);}); } }
        function openProfile(u){ db.collection('users').doc(u).get().then(d=>{const f=d.data();$('#profile-name').text(f.username);$('#profile-id').text(`#${f.displayId}`);$('#profile-wins').text(f.wins||0);let b=`<button onclick="inviteFriend('${u}','${f.username}')" class="btn btn-primary w-100">Herausfordern</button>`;$('#profile-actions').html(b);$('#profile-modal').removeClass('hidden');});}
        function inviteFriend(u,n){ const g=db.collection('games').doc(); g.set({white:currentUser.uid,whiteName:userData.username,whiteId:userData.displayId,whiteSkin:userData.equippedSkin,black:u,blackName:n,blackId:'?',fen:'start',turn:'w',status:'waiting_friend',createdAt:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{ db.collection('users').doc(u).collection('notifications').add({type:'game_invite',fromUid:currentUser.uid,title:'Herausforderung',message:`${userData.username} fordert dich.`,payload:g.id,timestamp:firebase.firestore.FieldValue.serverTimestamp()}); closeModal('profile-modal'); db.collection('users').doc(currentUser.uid).update({activeGameId:g.id}); loadOnlineGame(g.id); }); }
        function showPrivateMenu() { $('#private-menu-modal').removeClass('hidden'); }
        function openPrivateCreate() { closeModal('private-menu-modal'); const c=Math.random().toString(36).substring(2,7).toUpperCase(); db.collection('games').doc(c).set({white:currentUser.uid,whiteName:userData.username,whiteId:userData.displayId,whiteSkin:userData.equippedSkin,status:'waiting_private',fen:'start',turn:'w',createdAt:firebase.firestore.FieldValue.serverTimestamp()}); $('#host-code-display').text(c); $('#private-create-modal').removeClass('hidden'); hostListener=db.collection('games').doc(c).onSnapshot(d=>{if(d.exists&&d.data().status==='active'){hostListener();closeModal('private-create-modal');db.collection('users').doc(currentUser.uid).update({activeGameId:c});loadOnlineGame(c);}}); currentGameId=c; }
        function cancelPrivateHost() { if(hostListener)hostListener(); if(currentGameId)db.collection('games').doc(currentGameId).delete(); closeModal('private-create-modal'); }
        function openPrivateJoin() { closeModal('private-menu-modal'); $('#private-join-input').val(''); $('#private-join-modal').removeClass('hidden'); }
        function submitPrivateJoin() { const c=$('#private-join-input').val().trim().toUpperCase(); db.collection('games').doc(c).get().then(d=>{if(d.exists&&d.data().status==='waiting_private'){db.collection('games').doc(c).update({black:currentUser.uid,blackName:userData.username,blackId:userData.displayId,blackSkin:userData.equippedSkin,status:'active'}).then(()=>{closeModal('private-join-modal');db.collection('users').doc(currentUser.uid).update({activeGameId:c});loadOnlineGame(c);});}else alert("Fehler");}); }
        function spectateGame(id) { closeModal('profile-modal'); loadOnlineGame(id, true); }
        function saveSettings(){ const n=$('#settings-username').val(); if(n&&n!==userData.username)db.collection('users').doc(currentUser.uid).update({username:n}); closeModal('settings-modal'); }
    </script>
</body>
</html>
