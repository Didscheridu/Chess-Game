<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Masters Pro - Ranked Queue</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #18191a; color: #e4e6eb; font-family: 'Roboto', sans-serif; }
        .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .card-dark { background-color: #242526; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid #333; }
        .btn-primary-custom { background-color: #2D88FF; color: white; font-weight: bold; border: none; }
        .btn-primary-custom:hover { background-color: #1A73E8; color: white; }
        
        .hidden { display: none !important; }
        .id-badge { background: #3a3b3c; color: #b0b3b8; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }

        #board { width: 100%; border: 4px solid #3a3b3c; border-radius: 4px; }
        .board-wrapper { position: relative; max-width: 550px; margin: 0 auto; }
        
        /* Queue Overlay */
        #queue-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(36, 37, 38, 0.95); z-index: 500;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            border-radius: 10px;
        }
        .pulse-ring {
            border: 4px solid #2D88FF; border-radius: 50%; height: 60px; width: 60px;
            animation: pulsate 2s infinite; margin-bottom: 20px;
        }
        @keyframes pulsate { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

        /* End Screen Overlay */
        #end-screen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 5000;
            display: flex; justify-content: center; align-items: center;
        }
        .end-card { background: #242526; padding: 40px; border-radius: 20px; text-align: center; border: 2px solid #444; min-width: 300px; }
        .win-title { font-size: 3rem; font-weight: 900; color: #2ecc71; text-shadow: 0 0 20px rgba(46, 204, 113, 0.5); }
        .lose-title { font-size: 3rem; font-weight: 900; color: #e74c3c; text-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .modal-content-custom { background: #242526; width: 400px; padding: 20px; border-radius: 10px; border: 1px solid #3a3b3c; }

        .move-log { height: 250px; overflow-y: auto; background: #18191a; padding: 10px; border-radius: 6px; }
    </style>
</head>
<body>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content-custom">
            <h4>Einstellungen</h4>
            <input type="text" id="settings-username" class="form-control mb-3" placeholder="Neuer Name">
            <input type="password" id="settings-password" class="form-control mb-3" placeholder="Neues Passwort">
            <button onclick="adminFixUserIds()" class="btn btn-warning btn-sm w-100 mb-3">⚠️ Admin: IDs reparieren</button>
            <div class="d-flex justify-content-end gap-2">
                <button onclick="closeSettings()" class="btn btn-secondary">Abbrechen</button>
                <button onclick="saveSettings()" class="btn btn-success">Speichern</button>
            </div>
            <div id="settings-msg" class="mt-2 small"></div>
        </div>
    </div>

    <div id="end-screen-overlay" class="hidden">
        <div class="end-card">
            <div id="end-title" class="win-title">SIEG!</div>
            <p id="end-reason" class="text-muted my-3">...</p>
            <button onclick="backToLobby()" class="btn btn-light btn-lg w-100 fw-bold">Zurück zur Lobby</button>
        </div>
    </div>

    <div class="app-container">
        
        <div class="d-flex justify-content-between align-items-center mb-4 p-3 card-dark">
            <h3 class="m-0 fw-bold"><i class="fas fa-chess"></i> CHESS PRO</h3>
            <div id="nav-user-area" class="hidden d-flex align-items-center gap-3">
                <div>
                    <span id="nav-username" class="fw-bold text-white">Gast</span>
                    <span id="nav-userid" class="id-badge">#?</span>
                </div>
                <button onclick="openSettings()" class="btn btn-sm btn-outline-light"><i class="fas fa-cog"></i></button>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
            </div>
        </div>

        <div id="auth-screen">
            <div class="card-dark text-center" style="max-width: 400px; margin: 50px auto;">
                <h3>Login</h3>
                <p class="text-muted small">ID System aktiv</p>
                <input type="email" id="email-input" class="form-control mb-2" placeholder="E-Mail">
                <input type="password" id="password-input" class="form-control mb-3" placeholder="Passwort">
                <input type="text" id="username-input" class="form-control mb-3" placeholder="Username (nur Registrierung)">
                <button onclick="loginUser()" class="btn btn-primary-custom w-100 mb-2">Login</button>
                <button onclick="registerUserWithId()" class="btn btn-outline-light w-100">Konto erstellen</button>
                <div id="auth-error" class="text-danger mt-2 small"></div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden">
            <div class="row">
                <div class="col-md-7">
                    <div class="card-dark text-center" style="padding: 40px 20px; position: relative; min-height: 400px;">
                        
                        <div id="queue-overlay" class="hidden">
                            <div class="pulse-ring"></div>
                            <h3>Suche Gegner...</h3>
                            <p class="text-muted">Du bist in der Warteschlange.</p>
                            <p class="small text-muted" id="queue-time">Wartezeit: 0s</p>
                            <button onclick="leaveQueue()" class="btn btn-outline-danger mt-3">Abbrechen</button>
                        </div>

                        <h1 class="fw-bold mb-4">Bereit?</h1>
                        <button onclick="joinQueue()" id="btn-matchmaking" class="btn btn-primary-custom btn-lg w-100 py-4 mb-4" style="font-size: 1.5em; box-shadow: 0 0 15px rgba(45, 136, 255, 0.5);">
                            <i class="fas fa-play"></i> SPIEL SUCHEN
                        </button>
                        
                        <hr>
                        <div class="d-flex justify-content-center gap-2 mt-3">
                            <input type="text" id="join-id-input" class="form-control" style="max-width: 150px;" placeholder="Code eingeben...">
                            <button onclick="joinGameByCode()" class="btn btn-secondary">Beitreten</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-5">
                    <div class="card-dark">
                        <h5 class="text-warning"><i class="fas fa-trophy"></i> Top Wins</h5>
                        <div id="leaderboard-list" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="row">
                <div class="col-lg-7">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="player-top"><i class="fas fa-user"></i> Gegner</span>
                        <span id="game-status-text" class="badge bg-success">Spiel läuft</span>
                    </div>
                    
                    <div class="board-wrapper">
                        <div id="board"></div>
                    </div>

                    <div class="mt-2">
                        <span id="player-bottom"><i class="fas fa-user"></i> Du</span>
                    </div>
                </div>

                <div class="col-lg-5 mt-3 mt-lg-0">
                    <div class="card-dark h-100 d-flex flex-column">
                        <h5>Verlauf</h5>
                        <div id="move-history" class="move-log flex-grow-1 mb-3"></div>
                        <button onclick="leaveGame()" class="btn btn-danger w-100">Aufgeben / Verlassen</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqCKRhB87r_r-IgbOd9ESm9MQLKTGwSU0",
            authDomain: "chess-dff93.firebaseapp.com",
            projectId: "chess-dff93",
            storageBucket: "chess-dff93.firebasestorage.app",
            messagingSenderId: "1013706120323",
            appId: "1:1013706120323:web:768c8e77c5f49479150fb6",
            measurementId: "G-SK8BMR8YKF"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let userData = null;
        let game = new Chess();
        let board = null;
        let currentGameId = null;
        let myColor = 'w';
        let gameListener = null;
        let queueListener = null;
        let queueTimerInterval = null;

        // --- 2. AUTH & INIT ---
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        userData = doc.data();
                        updateNavUI();
                        showScreen('lobby-screen');
                        updateLeaderboard();
                        // WICHTIG: Prüfen ob wir noch in der Queue sind (Page Reload)
                        checkQueueStatus();
                    }
                });
            } else {
                showScreen('auth-screen');
            }
        });

        // --- 3. DAS NEUE QUEUE SYSTEM ---
        
        // A. Der Queue beitreten
        function joinQueue() {
            if(!userData) return;
            
            // UI sofort ändern
            showQueueUI();

            // Eintrag in Queue Collection erstellen
            const queueRef = db.collection('queue').doc(currentUser.uid);
            
            queueRef.set({
                uid: currentUser.uid,
                username: userData.username,
                displayId: userData.displayId,
                joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                gameId: null // Noch kein Spiel gefunden
            }).then(() => {
                // Sobald wir drin sind, versuchen wir zu matchen
                attemptMatchmaking();
                // Und wir hören zu, falls uns jemand anders matcht
                listenToMyQueueEntry();
            });
        }

        // B. Versuch, zwei Spieler zu paaren
        async function attemptMatchmaking() {
            try {
                // Wir holen die ältesten Einträge (FIFO)
                const snapshot = await db.collection('queue')
                    .orderBy('joinedAt', 'asc')
                    .limit(2) // Wir brauchen nur 2 Leute
                    .get();

                if (snapshot.size >= 2) {
                    const player1 = snapshot.docs[0].data();
                    const player2 = snapshot.docs[1].data();

                    // Transaktion um Race-Conditions zu vermeiden
                    await db.runTransaction(async (transaction) => {
                        // Spiel erstellen
                        const newGameRef = db.collection('games').doc();
                        
                        // Queue Einträge aktualisieren (damit beide Clients bescheid wissen)
                        transaction.update(db.collection('queue').doc(player1.uid), { gameId: newGameRef.id });
                        transaction.update(db.collection('queue').doc(player2.uid), { gameId: newGameRef.id });
                        
                        // Das Spiel in der DB anlegen
                        transaction.set(newGameRef, {
                            white: player1.uid, whiteName: player1.username, whiteId: player1.displayId,
                            black: player2.uid, blackName: player2.username, blackId: player2.displayId,
                            fen: 'start', turn: 'w', status: 'active', result: null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    console.log("Match erstellt!");
                } else {
                    console.log("Warte auf zweiten Spieler...");
                }
            } catch (e) {
                console.log("Matching konflikt (normal):", e);
            }
        }

        // C. Zuhören, ob ich gematcht wurde
        function listenToMyQueueEntry() {
            if(queueListener) queueListener(); // Reset
            
            queueListener = db.collection('queue').doc(currentUser.uid).onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    // Wurde ein Spiel gefunden?
                    if(data.gameId) {
                        // Juhu! Spiel laden.
                        loadGame(data.gameId, (data.uid === currentUser.uid) ? 'unknown_yet' : 'unknown_yet'); 
                        // Wir wissen Farbe noch nicht sicher, loadGame holt das aus dem Game Doc
                        
                        // Aus Queue löschen (Cleanup)
                        db.collection('queue').doc(currentUser.uid).delete();
                    }
                } else {
                    // Falls mein Eintrag gelöscht wurde (z.B. manuell), Queue UI beenden
                    hideQueueUI();
                }
            });
        }

        // D. Queue verlassen
        function leaveQueue() {
            db.collection('queue').doc(currentUser.uid).delete();
            hideQueueUI();
        }

        // E. Beim Neuladen prüfen
        function checkQueueStatus() {
            db.collection('queue').doc(currentUser.uid).get().then(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    if(data.gameId) {
                        // Spiel war schon bereit
                        loadGame(data.gameId, 'w'); // Farbe wird eh korrigiert
                        db.collection('queue').doc(currentUser.uid).delete();
                    } else {
                        // Noch am Warten -> UI zeigen
                        showQueueUI();
                        listenToMyQueueEntry();
                        // Auch nochmal versuchen zu matchen (falls der andere gewartet hat)
                        attemptMatchmaking();
                    }
                }
            });
        }

        // UI Helper für Queue
        function showQueueUI() {
            $('#queue-overlay').removeClass('hidden');
            let seconds = 0;
            if(queueTimerInterval) clearInterval(queueTimerInterval);
            queueTimerInterval = setInterval(() => {
                seconds++;
                $('#queue-time').text(`Wartezeit: ${seconds}s`);
            }, 1000);
        }

        function hideQueueUI() {
            $('#queue-overlay').addClass('hidden');
            if(queueTimerInterval) clearInterval(queueTimerInterval);
            if(queueListener) queueListener();
        }


        // --- 4. GAME ENGINE (WIE VORHER) ---
        function loadGame(id, colorPlaceholder) {
            currentGameId = id;
            hideQueueUI(); // Sicherstellen, dass Overlay weg ist
            showScreen('game-screen');
            game = new Chess();
            $('#move-history').empty();
            $('#end-screen-overlay').addClass('hidden');

            // Erstmal leer initialisieren
            board = Chessboard('board', { position: 'start' });

            if(gameListener) gameListener();
            
            gameListener = db.collection('games').doc(id).onSnapshot(doc => {
                const data = doc.data();
                if(!data) return; 

                // FARBE BESTIMMEN (Wichtig!)
                if (data.white === currentUser.uid) myColor = 'w';
                else if (data.black === currentUser.uid) myColor = 'b';
                else myColor = 'spectator'; // Sollte nicht passieren

                // UI Update
                const wName = `${data.whiteName} (#${data.whiteId})`;
                const bName = `${data.blackName} (#${data.blackId})`;
                
                if(myColor === 'w') {
                    $('#player-bottom').text(`Du (Weiß)`);
                    $('#player-top').text(`${bName} (Schwarz)`);
                    board.orientation('white');
                } else {
                    $('#player-bottom').text(`Du (Schwarz)`);
                    $('#player-top').text(`${wName} (Weiß)`);
                    board.orientation('black');
                }
                
                // Config mit korrekter Orientation neu setzen
                const config = {
                    draggable: true, position: 'start', orientation: (myColor==='w'?'white':'black'),
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                    onDragStart: onDragStart, onDrop: onDrop, onSnapEnd: () => board.position(game.fen())
                };
                board = Chessboard('board', config); // Reload Board

                // --- ABORT CHECK ---
                if(data.status === 'aborted') {
                    showEndScreen('GEWONNEN!', 'Gegner hat das Spiel verlassen.', 'win');
                    return;
                }

                // --- MOVE UPDATE ---
                if(data.fen && data.fen !== game.fen()) {
                    game.load(data.fen);
                    board.position(data.fen);
                    if(data.lastMoveSan) addLog(data.lastMoveSan);
                }

                // --- RESULT CHECK ---
                if (data.result) handleGameEnd(data.result);
            });
        }

        function handleGameEnd(result) {
            if (result === 'draw') showEndScreen('REMIS', 'Unentschieden.', 'draw');
            else if (result === myColor) showEndScreen('GEWONNEN!', 'Du hast gewonnen.', 'win');
            else showEndScreen('VERLOREN', 'Schachmatt.', 'lose');
        }

        function showEndScreen(title, reason, type) {
            $('#end-screen-overlay').removeClass('hidden');
            $('#end-title').text(title);
            $('#end-reason').text(reason);
            $('#end-title').removeClass('win-title lose-title draw-title');
            if(type === 'win') $('#end-title').addClass('win-title');
            if(type === 'lose') $('#end-title').addClass('lose-title');
            if(type === 'draw') $('#end-title').addClass('draw-title');
        }

        function onDragStart(source, piece) {
            if(game.game_over() || game.turn() !== myColor) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) || 
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            let result = null;
            let status = 'active';

            if (game.game_over()) {
                if (game.in_checkmate()) {
                    result = game.turn() === 'w' ? 'b' : 'w'; 
                    incrementWins();
                } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) {
                    result = 'draw';
                }
                status = 'finished';
            }

            db.collection('games').doc(currentGameId).update({
                fen: game.fen(), turn: game.turn(), lastMoveSan: move.san,
                result: result, status: status
            });
            addLog(move.san);
        }

        function incrementWins() {
            db.collection('users').doc(currentUser.uid).update({ wins: firebase.firestore.FieldValue.increment(1) });
        }

        function leaveGame() {
            if(confirm("Aufgeben?")) {
                if(currentGameId) db.collection('games').doc(currentGameId).update({ status: 'aborted' });
                backToLobby();
            }
        }
        
        function backToLobby() {
            if(gameListener) gameListener();
            showScreen('lobby-screen');
        }

        // --- HELPER & AUTH ---
        function registerUserWithId() {
            const email = $('#email-input').val(); const pass = $('#password-input').val(); const name = $('#username-input').val();
            if(!name) return;
            const cRef = db.collection('config').doc('userCounter');
            auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                db.runTransaction(async (t) => {
                    const d = await t.get(cRef); let n = d.exists ? d.data().count + 1 : 1;
                    t.set(cRef, { count: n });
                    t.set(db.collection('users').doc(cred.user.uid), { username: name, displayId: n, uid: cred.user.uid, wins: 0 });
                });
            }).catch(e => $('#auth-error').text(e.message));
        }
        function loginUser() { auth.signInWithEmailAndPassword($('#email-input').val(), $('#password-input').val()).catch(e=>$('#auth-error').text(e.message)); }
        function logout() { auth.signOut(); location.reload(); }
        function updateNavUI() { $('#nav-username').text(userData.username); $('#nav-userid').text('#'+userData.displayId); $('#nav-user-area').removeClass('hidden'); }
        function updateLeaderboard() {
            db.collection('users').orderBy('wins', 'desc').limit(10).onSnapshot(s => {
                let h=''; let r=1; s.forEach(d=>{ let u=d.data(); h+=`<div class="d-flex justify-content-between p-2 border-bottom border-dark"><span>#${r} ${u.username}</span><span class="badge bg-secondary">${u.wins||0}</span></div>`; r++; });
                $('#leaderboard-list').html(h);
            });
        }
        function addLog(s) { $('#move-history').append(`<div>${s}</div>`).scrollTop(999); }
        function showScreen(id) { $('.hidden').removeClass('hidden').addClass('hidden'); $('#auth-screen, #lobby-screen, #game-screen').addClass('hidden'); $('#'+id).removeClass('hidden'); }
        function joinGameByCode() { /* Code Join Logic same as before */ }
        function openSettings(){ $('#settings-modal').removeClass('hidden'); }
        function closeSettings(){ $('#settings-modal').addClass('hidden'); }
        function saveSettings(){ /* Save logic same as before */ closeSettings(); }
        async function adminFixUserIds() { /* Fix logic same as before */ }
    </script>
</body>
</html>
